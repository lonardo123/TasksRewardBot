<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>👷‍♂️ Worker Auto Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Cairo", sans-serif;
      background: #f3f4f6;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    #status-text {
      font-size: 20px;
      margin-top: 20px;
    }
    #progress-bar {
      width: 80%;
      height: 10px;
      background-color: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 20px;
    }
    #progress {
      height: 10px;
      width: 0%;
      background-color: #1d4ed8;
      transition: width 1s linear;
    }
  </style>
</head>
<body>
  <h2>👷‍♂️ العامل يعمل تلقائيًا...</h2>
  <div id="status-text">جارٍ تحميل الفيديوهات من السيرفر...</div>
  <div id="progress-bar"><div id="progress"></div></div>

  <script>
    const USER_ID = new URLSearchParams(window.location.search).get("user_id") || "anonymous";
    const API_BASE = "https://perceptive-victory-production.up.railway.app";
    const API_PUBLIC = `${API_BASE}/api/public-videos`;
    const API_MYVIDEOS = `${API_BASE}/api/my-videos?user_id=${USER_ID}`;
    const API_CALLBACK = `${API_BASE}/video-callback`;
    const SECRET_KEY = "MySuperSecretKey123ForCallbackOnly";

    const statusText = document.getElementById("status-text");
    const progressBar = document.getElementById("progress");

    // ================================
    // 🧠 الخطوة 1: بدء دورة العمل
    // ================================
    async function startWorker() {
      try {
        statusText.textContent = "📡 يجري تحميل الفيديوهات...";
        const [publicRes, myRes] = await Promise.all([
          fetch(API_PUBLIC),
          fetch(API_MYVIDEOS)
        ]);

        const publicVideos = await publicRes.json();
        const myVideos = await myRes.json();

        // استبعاد فيديوهات المستخدم نفسه
        const myIds = new Set(myVideos.map(v => v.id));
        const available = publicVideos.filter(v => !myIds.has(v.id));

        if (available.length === 0) {
          statusText.textContent = "😔 لا توجد فيديوهات متاحة حالياً.";
          return;
        }

        const randomVideo = available[Math.floor(Math.random() * available.length)];
        const videoUrl = randomVideo.url || randomVideo.link || randomVideo.video_url;
        const duration = randomVideo.required_watch_seconds || randomInt(20, 60);

        statusText.textContent = `🎬 فتح الفيديو (${duration} ثانية)...`;

        // حفظ البيانات قبل الانتقال
        localStorage.setItem("current_video", JSON.stringify({
          video_id: randomVideo.id,
          url: videoUrl,
          duration,
          start: Date.now(),
          user: USER_ID
        }));

        // الانتقال لمشاهدة الفيديو فعلاً
        window.location.href = videoUrl;

      } catch (err) {
        console.error(err);
        statusText.textContent = "⚠️ فشل جلب الفيديوهات من السيرفر!";
      }
    }

    // ================================
    // 🧩 الخطوة 2: عند العودة من الفيديو
    // ================================
    window.addEventListener("load", async () => {
      const stored = localStorage.getItem("current_video");

      if (stored) {
        const { video_id, url, duration, start, user } = JSON.parse(stored);
        const watched = Math.floor((Date.now() - start) / 1000);

        if (watched >= duration) {
          // تم استيفاء مدة المشاهدة المطلوبة بالكامل
          await sendReward(user, video_id, duration);
          localStorage.removeItem("current_video");
          statusText.textContent = "✅ تمت إضافة المكافأة!";
          await wait(3);
          await simulateProgress(3);
          await startWorker(); // تشغيل الفيديو التالي تلقائيًا
          return;
        } else {
          const remaining = duration - watched;
          statusText.textContent = `⏳ تحتاج لمشاهدة ${remaining} ثانية إضافية لإكمال الفيديو.`;
          await wait(remaining);
          await sendReward(user, video_id, duration);
          localStorage.removeItem("current_video");
          statusText.textContent = "✅ تمت إضافة المكافأة!";
          await wait(3);
          await simulateProgress(3);
          await startWorker(); // الفيديو التالي
          return;
        }
      }

      // في حال لا يوجد فيديو سابق مخزّن
      await simulateProgress(3);
      await startWorker();
    });

    // ================================
    // 💰 إرسال الدفع بعد المشاهدة
    // ================================
    async function sendReward(user_id, video_id, watched_seconds) {
      try {
        const callbackUrl = `${API_CALLBACK}?user_id=${user_id}&video_id=${video_id}&watched_seconds=${watched_seconds}&secret=${SECRET_KEY}`;
        statusText.textContent = "💰 يتم إرسال المكافأة...";
        await fetch(callbackUrl);
      } catch (err) {
        console.warn("⚠️ فشل إرسال الدفع:", err);
      }
    }

    // ================================
    // 🔧 أدوات مساعدة
    // ================================
    async function simulateProgress(duration) {
      for (let i = 1; i <= duration; i++) {
        progressBar.style.width = `${(i / duration) * 100}%`;
        await wait(1);
      }
      progressBar.style.width = "0%";
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function wait(sec) {
      return new Promise(res => setTimeout(res, sec * 1000));
    }
  </script>
</body>
</html>
