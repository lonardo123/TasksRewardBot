<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Worker Start (بدون iframe)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Cairo", sans-serif;
      background: #f3f4f6;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #status-text {
      font-size: 20px;
      margin-top: 20px;
      color: #333;
      text-align: center;
    }
    #progress-bar {
      width: 80%;
      height: 10px;
      background-color: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 20px;
    }
    #progress {
      height: 10px;
      width: 0%;
      background-color: #1d4ed8;
      transition: width 1s linear;
    }
    #next-btn {
      margin-top: 30px;
      background: #1d4ed8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2>👷‍♂️ العامل قيد التشغيل...</h2>
  <div id="status-text">جارٍ اختيار فيديو عشوائي...</div>
  <div id="progress-bar"><div id="progress"></div></div>
  <button id="next-btn" style="display:none;">▶️ عرض الفيديو الآن</button>

  <script>
    const USER_ID = new URLSearchParams(window.location.search).get("user_id") || "anonymous";
    const API_CALLBACK = "https://perceptive-victory-production.up.railway.app/callback";
    const SECRET_KEY = "MySuperSecretKey123ForCallbackOnly";

    const statusText = document.getElementById("status-text");
    const progressBar = document.getElementById("progress");
    const nextBtn = document.getElementById("next-btn");

    const SOURCES = [
      () => randomYouTube(),
      () => randomFacebook(),
      () => randomInstagram(),
      () => randomGoogleSearch()
    ];

    async function startLoop() {
      while (true) {
        const randomSource = SOURCES[Math.floor(Math.random() * SOURCES.length)];
        const url = randomSource();
        const duration = randomInt(20, 50);

        statusText.textContent = `🔗 الرابط القادم من: ${getDomain(url)}`;
        nextBtn.style.display = "block";
        nextBtn.onclick = () => openVideo(url, duration);
        break; // ينتظر المستخدم يضغط الزر
      }
    }

    async function openVideo(url, duration) {
      nextBtn.style.display = "none";
      statusText.textContent = `🎬 فتح الفيديو الآن (${duration} ثانية)...`;

      // احفظ بيانات المشاهدة في localStorage مؤقتًا
      localStorage.setItem("current_video", JSON.stringify({ url, duration, start: Date.now(), user: USER_ID }));

      // فتح الرابط فعليًا في نفس التبويب
      window.location.href = url;
    }

    // عند العودة من الفيديو إلى worker/start مرة أخرى
    window.addEventListener("load", async () => {
      const stored = localStorage.getItem("current_video");
      if (stored) {
        const { url, duration, start, user } = JSON.parse(stored);
        const watched = Math.floor((Date.now() - start) / 1000);

        if (watched >= 5) {
          await sendReward(url, Math.min(watched, duration));
          localStorage.removeItem("current_video");
          statusText.textContent = "✅ تمت إضافة المكافأة!";
          await wait(3);
        }
      }

      await simulateProgress(3);
      await startLoop();
    });

    async function sendReward(sourceUrl, watched_seconds) {
      try {
        const payload = { user_id: USER_ID, source: sourceUrl, watched_seconds, secret: SECRET_KEY };
        await fetch(API_CALLBACK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.warn("⚠️ فشل إرسال المكافأة:", err);
      }
    }

    async function simulateProgress(duration) {
      for (let i = 1; i <= duration; i++) {
        progressBar.style.width = `${(i / duration) * 100}%`;
        await wait(1);
      }
      progressBar.style.width = "0%";
    }

    function randomYouTube() {
      const queries = ["music", "funny", "news", "science", "travel", "football"];
      const q = queries[Math.floor(Math.random() * queries.length)];
      return `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`;
    }

    function randomFacebook() {
      const pages = [
        "https://www.facebook.com/UNILAD/",
        "https://www.facebook.com/9GAG/",
        "https://www.facebook.com/BBCNews/",
        "https://www.facebook.com/NASA/"
      ];
      return pages[Math.floor(Math.random() * pages.length)];
    }

    function randomInstagram() {
      const profiles = [
        "https://www.instagram.com/natgeo/",
        "https://www.instagram.com/nasa/",
        "https://www.instagram.com/9gag/",
        "https://www.instagram.com/bbcnews/"
      ];
      return profiles[Math.floor(Math.random() * profiles.length)];
    }

    function randomGoogleSearch() {
      const topics = ["funny videos", "football", "animals", "movies", "food"];
      const q = topics[Math.floor(Math.random() * topics.length)];
      return `https://www.google.com/search?q=${encodeURIComponent(q)}&tbm=vid`;
    }

    function getDomain(url) {
      try { return new URL(url).hostname.replace("www.", ""); }
      catch { return "unknown"; }
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function wait(sec) {
      return new Promise(res => setTimeout(res, sec * 1000));
    }
  </script>
</body>
</html>
