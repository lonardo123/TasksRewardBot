<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>ğŸ‘·â€â™‚ï¸ Worker Auto Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Cairo", sans-serif;
      background: #f3f4f6;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    #status-text {
      font-size: 20px;
      margin-top: 20px;
    }
    #progress-bar {
      width: 80%;
      height: 10px;
      background-color: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 20px;
    }
    #progress {
      height: 10px;
      width: 0%;
      background-color: #1d4ed8;
      transition: width 1s linear;
    }
  </style>
</head>
<body>
  <h2>ğŸ‘·â€â™‚ï¸ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙŠØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§...</h2>
  <div id="status-text">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>
  <div id="progress-bar"><div id="progress"></div></div>

  <script>
    const USER_ID = new URLSearchParams(window.location.search).get("user_id") || "anonymous";
    const API_BASE = "https://perceptive-victory-production.up.railway.app";
    const API_PUBLIC = `${API_BASE}/api/public-videos`;
    const API_MYVIDEOS = `${API_BASE}/api/my-videos?user_id=${USER_ID}`;
    const API_CALLBACK = `${API_BASE}/video-callback`;
    const SECRET_KEY = "MySuperSecretKey123ForCallbackOnly";

    const statusText = document.getElementById("status-text");
    const progressBar = document.getElementById("progress");

    // ================================
    // ğŸ§  Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„
    // ================================
    async function startWorker() {
      try {
        statusText.textContent = "ğŸ“¡ ÙŠØ¬Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª...";
        const [publicRes, myRes] = await Promise.all([
          fetch(API_PUBLIC),
          fetch(API_MYVIDEOS)
        ]);

        const publicVideos = await publicRes.json();
        const myVideos = await myRes.json();

        // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡
        const myIds = new Set(myVideos.map(v => v.id));
        const available = publicVideos.filter(v => !myIds.has(v.id));

        if (available.length === 0) {
          statusText.textContent = "ğŸ˜” Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.";
          return;
        }

        const randomVideo = available[Math.floor(Math.random() * available.length)];
        const videoUrl = randomVideo.url || randomVideo.link || randomVideo.video_url;
        const duration = randomVideo.required_watch_seconds || randomInt(20, 60);

        statusText.textContent = `ğŸ¬ ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (${duration} Ø«Ø§Ù†ÙŠØ©)...`;

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
        localStorage.setItem("current_video", JSON.stringify({
          video_id: randomVideo.id,
          url: videoUrl,
          duration,
          start: Date.now(),
          user: USER_ID
        }));

        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙØ¹Ù„Ø§Ù‹
        window.location.href = videoUrl;

      } catch (err) {
        console.error(err);
        statusText.textContent = "âš ï¸ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±!";
      }
    }

    // ================================
    // ğŸ§© Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    // ================================
    window.addEventListener("load", async () => {
      const stored = localStorage.getItem("current_video");

      if (stored) {
        const { video_id, url, duration, start, user } = JSON.parse(stored);
        const watched = Math.floor((Date.now() - start) / 1000);

        if (watched >= duration) {
          // ØªÙ… Ø§Ø³ØªÙŠÙØ§Ø¡ Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
          await sendReward(user, video_id, duration);
          localStorage.removeItem("current_video");
          statusText.textContent = "âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©!";
          await wait(3);
          await simulateProgress(3);
          await startWorker(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
          return;
        } else {
          const remaining = duration - watched;
          statusText.textContent = `â³ ØªØ­ØªØ§Ø¬ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ${remaining} Ø«Ø§Ù†ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.`;
          await wait(remaining);
          await sendReward(user, video_id, duration);
          localStorage.removeItem("current_video");
          statusText.textContent = "âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©!";
          await wait(3);
          await simulateProgress(3);
          await startWorker(); // Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ
          return;
        }
      }

      // ÙÙŠ Ø­Ø§Ù„ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ø³Ø§Ø¨Ù‚ Ù…Ø®Ø²Ù‘Ù†
      await simulateProgress(3);
      await startWorker();
    });

    // ================================
    // ğŸ’° Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯ÙØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
    // ================================
    async function sendReward(user_id, video_id, watched_seconds) {
      try {
        const callbackUrl = `${API_CALLBACK}?user_id=${user_id}&video_id=${video_id}&watched_seconds=${watched_seconds}&secret=${SECRET_KEY}`;
        statusText.textContent = "ğŸ’° ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©...";
        await fetch(callbackUrl);
      } catch (err) {
        console.warn("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯ÙØ¹:", err);
      }
    }

    // ================================
    // ğŸ”§ Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
    // ================================
    async function simulateProgress(duration) {
      for (let i = 1; i <= duration; i++) {
        progressBar.style.width = `${(i / duration) * 100}%`;
        await wait(1);
      }
      progressBar.style.width = "0%";
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function wait(sec) {
      return new Promise(res => setTimeout(res, sec * 1000));
    }
  </script>
</body>
</html>
