<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Worker Start</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      font-family: "Cairo", sans-serif;
    }

    #loader-wrapper {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #loader {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      display: inline-block;
      border: 3px solid;
      border-color: #aea8a8 #aea8a8 transparent transparent;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
      position: relative;
    }

    #loader::after,
    #loader::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: auto;
      border: 3px solid;
      border-color: transparent transparent rgb(29, 78, 217) rgb(29, 78, 217);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      animation: rotationBack 0.5s linear infinite;
      transform-origin: center center;
    }

    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes rotationBack {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(-360deg); }
    }

    #message {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
      color: #686262;
      text-align: center;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }

    #video-container {
      display: none;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 900px;
      margin-top: 40px;
    }

    #video-frame {
      width: 90%;
      height: 480px;
      border: 2px solid #ccc;
      border-radius: 12px;
      background: #000;
    }

    #progress-bar {
      width: 90%;
      height: 8px;
      background-color: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 10px;
    }

    #progress {
      height: 8px;
      width: 0%;
      background-color: rgb(29, 78, 217);
      border-radius: 5px;
      transition: width 1s linear;
    }

    #status-text {
      margin-top: 10px;
      font-size: 16px;
      color: #444;
      font-weight: 500;
    }

    #ViewGripConsole {
      position: fixed;
      bottom: 15px;
      font-size: 13px;
      color: #666;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 6px 10px;
      direction: ltr;
      user-select: text;
    }

    #TextMessage {
      color: #222;
    }
  </style>
</head>
<body>
  <!-- شاشة التحميل -->
  <div id="loader-wrapper">
    <div id="loader"></div>
    <div id="message">جارٍ تهيئة العامل...</div>
  </div>

  <!-- واجهة المشاهدة -->
  <div id="video-container">
    <iframe id="video-frame" allowfullscreen></iframe>
    <div id="progress-bar">
      <div id="progress"></div>
    </div>
    <div id="status-text">جارٍ تحميل الفيديو...</div>
  </div>

  <!-- كونسول بسيط -->
  <div id="ViewGripConsole">
    <span style="color:#aaa;">@TasksRewardBot:</span>
    <span id="TextMessage">Waiting for worker initialization...</span>
  </div>

  <script>
    // ======================================================
    //  التقاط user_id من الرابط
    // ======================================================
    const params = new URLSearchParams(window.location.search);
    const USER_ID = params.get("user_id");

    // ======================================================
    //  روابط الـ API (تم تصحيح المسافات الزائدة!)
    // ======================================================
    const API_BASE = "https://perceptive-victory-production.up.railway.app";
    const API_PUBLIC = `${API_BASE}/api/videos/all`;
    const API_MYVIDEOS = `${API_BASE}/api/videos/user`;
    const API_CALLBACK = `${API_BASE}/callback`;
    const SECRET_KEY = "MySuperSecretKey123ForCallbackOnly";

    // ======================================================
    //  عناصر الواجهة
    // ======================================================
    const msgDiv = document.getElementById("message");
    const loaderDiv = document.getElementById("loader-wrapper");
    const videoDiv = document.getElementById("video-container");
    const iframe = document.getElementById("video-frame");
    const progressBar = document.getElementById("progress");
    const statusText = document.getElementById("status-text");
    const consoleMsg = document.getElementById("TextMessage");

    // ======================================================
    //  التحقق من user_id
    // ======================================================
    if (!USER_ID) {
      msgDiv.textContent = "⚠️ لم يتم العثور على user_id في الرابط.";
      consoleMsg.textContent = "Missing user_id in URL.";
      throw new Error("user_id parameter is missing from URL.");
    }

    // ======================================================
    //  تهيئة العامل
    // ======================================================
    async function initWorker() {
      consoleMsg.textContent = `Initializing for user_id=${USER_ID}`;
      msgDiv.textContent = "جارٍ جلب الفيديوهات...";

      try {
        const [allResp, myResp] = await Promise.all([
          fetch(API_PUBLIC),
          fetch(`${API_MYVIDEOS}?user_id=${USER_ID}`)
        ]);

        if (!allResp.ok || !myResp.ok) {
          throw new Error("فشل في جلب بيانات الفيديوهات");
        }

        const allVideos = await allResp.json();
        const myVideos = await myResp.json();

        const myIds = new Set(myVideos.map(v => v.id));
        const videos = allVideos.filter(v => !myIds.has(v.id));

        if (!videos.length) {
          msgDiv.textContent = "🎬 لا توجد فيديوهات متاحة حالياً.";
          consoleMsg.textContent = "No videos available.";
          return;
        }

        loaderDiv.style.display = "none";
        videoDiv.style.display = "flex";

        await startWatchingLoop(videos);
      } catch (err) {
        console.error("❌ خطأ أثناء جلب الفيديوهات:", err);
        msgDiv.textContent = "حدث خطأ أثناء الاتصال بالخادم.";
        consoleMsg.textContent = "Network or API error.";
      }
    }

    // ======================================================
    //  الحلقة الأساسية للمشاهدة
    // ======================================================
    async function startWatchingLoop(videos) {
      while (true) {
        const video = videos[Math.floor(Math.random() * videos.length)];
        const wrappedUrl = wrapUrl(video.url);
        const duration = video.duration || 30;

        iframe.src = wrappedUrl;
        statusText.textContent = "جارٍ تشغيل الفيديو...";
        consoleMsg.textContent = `▶️ Watching video ID ${video.id}`;

        await wait(3);
        monitorAds(iframe);

        await progress(duration);
        await sendReward(video.id, duration);

        statusText.textContent = "✅ تمت إضافة المكافأة إلى رصيدك";
        consoleMsg.textContent = `💰 Reward sent for video ${video.id}`;
        await wait(3);

        statusText.textContent = "جارٍ البحث عن فيديو جديد...";
        await wait(2);
      }
    }

    // ======================================================
    //  تغليف الروابط (Facebook / Google / Instagram)
    // ======================================================
    function wrapUrl(url) {
      const encoded = encodeURIComponent(url);
      const sources = [
        `https://l.facebook.com/l.php?u=${encoded}`,
        `https://l.instagram.com/?u=${encoded}`,
        `https://www.google.com/url?sa=t&url=${encoded}`
      ];
      return sources[Math.floor(Math.random() * sources.length)];
    }

    // ======================================================
    //  شريط التقدم
    // ======================================================
    async function progress(duration) {
      for (let i = 0; i <= duration; i++) {
        progressBar.style.width = `${(i / duration) * 100}%`;
        if (i % 10 === 0) simulateScroll();
        await wait(1);
      }
    }

    // ======================================================
    //  إرسال المكافأة
    // ======================================================
    async function sendReward(video_id, watched_seconds) {
      try {
        const url = `${API_CALLBACK}?user_id=${USER_ID}&video_id=${video_id}&watched_seconds=${watched_seconds}&secret=${SECRET_KEY}`;
        await fetch(url);
      } catch (err) {
        console.warn("⚠️ فشل إرسال المكافأة:", err);
      }
    }

    // ======================================================
    //  محاكاة التمرير داخل iframe
    // ======================================================
    function simulateScroll() {
      try {
        iframe.contentWindow.scrollBy({ top: Math.random() * 400, behavior: 'smooth' });
      } catch (e) {
        // قد يفشل بسبب CORS — لا مشكلة
      }
    }

    // ======================================================
    //  مراقبة الإعلانات وتخطيها تلقائيًا
    // ======================================================
    function monitorAds(iframe) {
      const interval = setInterval(() => {
        try {
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          if (!doc) return;
          const buttons = doc.querySelectorAll('button, div');
          for (const btn of buttons) {
            const txt = btn.innerText?.trim();
            if (/تخطي|Skip/i.test(txt)) {
              btn.click();
              statusText.textContent = "⏩ تم تخطي إعلان تلقائيًا";
              clearInterval(interval);
              break;
            }
          }
        } catch (e) {
          // تجاهل أخطاء CORS أو الوصول
        }
      }, 2000);
    }

    // ======================================================
    //  مساعدات
    // ======================================================
    function wait(sec) {
      return new Promise(res => setTimeout(res, sec * 1000));
    }

    // ======================================================
    //  بدء التشغيل عند تحميل الصفحة
    // ======================================================
    window.addEventListener("load", initWorker);
  </script>
</body>
</html>
