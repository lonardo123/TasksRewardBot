<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Worker Start</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      font-family: "Cairo", sans-serif;
    }

    #loader-wrapper {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #loader {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      display: inline-block;
      border: 3px solid;
      border-color: #aea8a8 #aea8a8 transparent transparent;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
      position: relative;
    }

    #loader::after,
    #loader::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: auto;
      border: 3px solid;
      border-color: transparent transparent rgb(29, 78, 217) rgb(29, 78, 217);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      animation: rotationBack 0.5s linear infinite;
      transform-origin: center center;
    }

    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes rotationBack {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(-360deg); }
    }

    #message {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
      color: #686262;
      text-align: center;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }

    #video-container {
      display: none;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 900px;
      margin-top: 40px;
    }

    #video-frame {
      width: 90%;
      height: 480px;
      border: 2px solid #ccc;
      border-radius: 12px;
      background: #000;
    }

    #progress-bar {
      width: 90%;
      height: 8px;
      background-color: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 10px;
    }

    #progress {
      height: 8px;
      width: 0%;
      background-color: rgb(29, 78, 217);
      border-radius: 5px;
      transition: width 1s linear;
    }

    #status-text {
      margin-top: 10px;
      font-size: 16px;
      color: #444;
      font-weight: 500;
    }

    #ViewGripConsole {
      position: fixed;
      bottom: 15px;
      font-size: 13px;
      color: #666;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 6px 10px;
      direction: ltr;
      user-select: text;
    }

    #TextMessage {
      color: #222;
    }
  </style>
</head>
<body>
  <div id="loader-wrapper">
    <div id="loader"></div>
    <div id="message">Ø¬Ø§Ø±Ù ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ù„...</div>
  </div>

  <div id="video-container">
    <iframe id="video-frame" allowfullscreen></iframe>
    <div id="progress-bar">
      <div id="progress"></div>
    </div>
    <div id="status-text">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...</div>
  </div>

  <div id="ViewGripConsole">
    <span style="color:#aaa;">@TasksRewardBot:</span>
    <span id="TextMessage">Waiting for worker initialization...</span>
  </div>

  <script>
    // Ø§Ù„ØªÙ‚Ø§Ø· user_id Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const params = new URLSearchParams(window.location.search);
    const USER_ID = params.get("user_id");

    // âœ… ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
    const API_BASE = "https://perceptive-victory-production.up.railway.app";
    const API_PUBLIC = `${API_BASE}/api/videos/all`;
    const API_MYVIDEOS = `${API_BASE}/api/videos/user`;
    const API_CALLBACK = `${API_BASE}/callback`;
    const SECRET_KEY = "MySuperSecretKey123ForCallbackOnly";

    const msgDiv = document.getElementById("message");
    const loaderDiv = document.getElementById("loader-wrapper");
    const videoDiv = document.getElementById("video-container");
    const iframe = document.getElementById("video-frame");
    const progressBar = document.getElementById("progress");
    const statusText = document.getElementById("status-text");
    const consoleMsg = document.getElementById("TextMessage");

    if (!USER_ID) {
      msgDiv.textContent = "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ user_id ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.";
      consoleMsg.textContent = "Missing user_id in URL.";
      throw new Error("user_id parameter is missing.");
    }

    async function initWorker() {
      consoleMsg.textContent = `Initializing for user_id=${USER_ID}`;
      msgDiv.textContent = "Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª...";

      try {
        const [allResp, myResp] = await Promise.all([
          fetch(API_PUBLIC),
          fetch(`${API_MYVIDEOS}?user_id=${USER_ID}`)
        ]);

        if (!allResp.ok || !myResp.ok) {
          throw new Error("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª");
        }

        const allVideos = await allResp.json();
        const myVideos = await myResp.json();

        const myIds = new Set(myVideos.map(v => v.id));
        const videos = allVideos.filter(v => !myIds.has(v.id));

        if (!videos.length) {
          msgDiv.textContent = "ğŸ¬ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…ØªØ§Ø­Ø©.";
          consoleMsg.textContent = "No videos available.";
          return;
        }

        loaderDiv.style.display = "none";
        videoDiv.style.display = "flex";

        await startWatchingLoop(videos);
      } catch (err) {
        console.error("âŒ Ø®Ø·Ø£:", err);
        msgDiv.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„.";
        consoleMsg.textContent = "Network error.";
      }
    }

    async function startWatchingLoop(videos) {
      while (true) {
        const video = videos[Math.floor(Math.random() * videos.length)];
        const wrappedUrl = wrapUrl(video.url);
        const duration = Math.max(video.duration || 30, 10); // min 10s

        iframe.src = wrappedUrl;
        statusText.textContent = "Ø¬Ø§Ø±Ù ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...";
        consoleMsg.textContent = `â–¶ï¸ Watching video ID ${video.id}`;

        // Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (3 Ø«ÙˆØ§Ù†ÙŠ)
        await wait(3);

        // Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… (Ù„Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ iframe)
        await simulateProgress(duration);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
        await sendReward(video.id, duration);

        statusText.textContent = "âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©";
        consoleMsg.textContent = `ğŸ’° Reward sent for video ${video.id}`;
        await wait(3);

        statusText.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯...";
        await wait(2);
      }
    }

    function wrapUrl(url) {
      const encoded = encodeURIComponent(url);
      const sources = [
        `https://l.facebook.com/l.php?u=${encoded}`,
        `https://l.instagram.com/?u=${encoded}`,
        `https://www.google.com/url?sa=t&url=${encoded}`
      ];
      return sources[Math.floor(Math.random() * sources.length)];
    }

    async function simulateProgress(duration) {
      const steps = duration;
      for (let i = 1; i <= steps; i++) {
        progressBar.style.width = `${(i / steps) * 100}%`;
        await wait(1);
      }
    }

    async function sendReward(video_id, watched_seconds) {
      try {
        const url = `${API_CALLBACK}?user_id=${USER_ID}&video_id=${video_id}&watched_seconds=${watched_seconds}&secret=${SECRET_KEY}`;
        await fetch(url, { method: 'POST' }); // ÙŠÙÙØ¶Ù„ POST Ù„Ø£Ù…Ø§Ù† Ø£ÙƒØ«Ø±
      } catch (err) {
        console.warn("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©:", err);
      }
    }

    function wait(sec) {
      return new Promise(res => setTimeout(res, sec * 1000));
    }

    window.addEventListener("load", initWorker);
  </script>
</body>
</html>
