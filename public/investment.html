<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg-primary:#020617;--bg-secondary:#1e293b;--border-color:#334155;--text-color:#fff;--success-color:#22c55e;--error-color:#ef4444;--warning-color:#475569}
body{background:var(--bg-primary);color:var(--text-color);font-family:Arial,sans-serif;padding:15px;margin:0}
.card{background:var(--bg-secondary);padding:18px;border-radius:12px;margin-bottom:20px;box-shadow:0 3px 5px rgba(0,0,0,0.2)}
.info{background:var(--bg-primary);border:1px solid var(--border-color);padding:14px;border-radius:10px;line-height:1.6;font-size:14px;margin-bottom:15px}
input,button{width:100%;padding:11px;margin-top:12px;border-radius:8px;border:none;font-size:15px}
input{background:var(--bg-primary);color:var(--text-color);border:1px solid var(--border-color);box-sizing:border-box}
button{cursor:pointer;font-weight:600}
button:hover{opacity:0.92}
.buy{background:var(--success-color);color:white}
.sell{background:var(--error-color);color:white}
.cancel{background:var(--warning-color);color:white}
.message{margin-top:14px;padding:10px;border-radius:6px;font-weight:bold;text-align:center}
.success{color:var(--success-color);background:rgba(34,197,94,0.1)}
.error{color:var(--error-color);background:rgba(239,68,68,0.1)}
table{width:100%;border-collapse:collapse;font-size:14px;margin-top:10px}
th,td{border:1px solid var(--border-color);padding:9px;text-align:center}
th{background:var(--border-color);font-weight:600;color:white}
.loading{text-align:center;padding:20px;color:#94a3b8}
</style>
</head>
<body>

<h2 id="title">ğŸ“ˆ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</h2>
<div class="info" id="investmentInfo"></div>

<div class="card">
  <div id="loadingUser" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  <div id="userData" style="display:none;">
    <p id="userId">ğŸ‘¤ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: --</p>
    <p id="price">ğŸ’° Ø§Ù„Ø³Ø¹Ø±: --</p>
    <p id="balance">ğŸ’µ Ø§Ù„Ø±ØµÙŠØ¯: --</p>
    <p id="stocks">ğŸ“¦ Ø§Ù„Ø£Ø³Ù‡Ù…: --</p>
    <p id="fee">ğŸ§¾ Ø§Ù„Ø±Ø³ÙˆÙ…: 0.05$ + 2%</p>
    <input id="amount" type="number" min="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
    <button class="buy" onclick="prepareAction('buy')">ğŸ›’ Ø´Ø±Ø§Ø¡</button>
    <button class="sell" onclick="prepareAction('sell')">ğŸ’¸ Ø¨ÙŠØ¹</button>
    <div id="msg" class="message"></div>
  </div>
</div>

<div class="card" id="confirmBox" style="display:none;">
  <div id="confirmText"></div>
  <button class="buy" onclick="confirmAction()">âœ… ØªØ£ÙƒÙŠØ¯</button>
  <button class="cancel" onclick="cancelAction()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
</div>

<div class="card">
  <h3>ğŸ“Š Ø§Ù„Ù…Ø®Ø·Ø·</h3>
  <div id="chartLoading" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  <canvas id="priceChart" height="180" style="display:none;"></canvas>
</div>

<div class="card">
  <h3>ğŸ“‘ Ø§Ù„Ø³Ø¬Ù„</h3>
  <div id="transactionsLoading" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  <div id="transactionsContent" style="display:none;">
    <table>
      <thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
      <tbody id="txTable"></tbody>
    </table>
  </div>
</div>

<script>
const params = new URLSearchParams(location.search);
const telegram_id = params.get('telegram_id') || '123456';
const lang = params.get('lang') || 'ar';

let stockPrice = 0, currentAction = null, adminFeeFixed = 0.05, adminFeePercent = 2, chartInstance = null, lastPriceCheck = null;

const texts = {
  ar:{title:"ğŸ“ˆ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±",info:`ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§.<br>Ø§Ù„Ø³Ø¹Ø± ÙŠØ±ØªÙØ¹ ÙˆÙŠÙ†Ø®ÙØ¶ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆÙ‚.<br>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ØªØ·Ø¨Ù‚ Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©.`,buy:"Ø´Ø±Ø§Ø¡",sell:"Ø¨ÙŠØ¹",invalidQuantity:"Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©",insufficientBalance:"Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ",operationSuccess:"ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­",serverError:"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…",noTransactions:"Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª"},
  en:{title:"ğŸ“ˆ Investment",info:`Buy and hold stocks.<br>Price fluctuates based on market.<br>Admin fee applies to all transactions.`,buy:"Buy",sell:"Sell",invalidQuantity:"Enter valid quantity",insufficientBalance:"Insufficient balance",operationSuccess:"Operation successful",serverError:"Server error",noTransactions:"No transactions"}
};

document.getElementById("title").innerText = texts[lang].title;
document.getElementById("investmentInfo").innerHTML = texts[lang].info;
document.documentElement.lang = lang;
document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

function showMsg(t,ok=true){const m=document.getElementById("msg");m.textContent=t;m.className="message "+(ok?"success":"error");setTimeout(()=>{if(m.textContent===t){m.textContent="";m.className="message"}},4000)}

async function loadInvestment(){
  try{
    document.getElementById("loadingUser").style.display="block";
    document.getElementById("userData").style.display="none";
    
    const r = await fetch(`/api/investment-data?user_id=${telegram_id}`);
    const d = await r.json();
    
    if(d.status!=="success") throw new Error(d.message||"ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„");
    
    stockPrice=Number(d.data.price);
    adminFeeFixed=Number(d.data.admin_fee_fixed);
    adminFeePercent=Number(d.data.admin_fee_percent);
    
    document.getElementById("userId").textContent=`ğŸ‘¤ ${lang==='ar'?'Ø§Ù„Ù…Ø¹Ø±Ù':'ID'}: ${telegram_id}`;
    document.getElementById("price").textContent=`ğŸ’° ${lang==='ar'?'Ø§Ù„Ø³Ø¹Ø±':'Price'}: ${stockPrice.toFixed(6)}$`;
    document.getElementById("balance").textContent=`ğŸ’µ ${lang==='ar'?'Ø§Ù„Ø±ØµÙŠØ¯':'Balance'}: ${Number(d.data.balance).toFixed(6)}$`;
    document.getElementById("stocks").textContent=`ğŸ“¦ ${lang==='ar'?'Ø§Ù„Ø£Ø³Ù‡Ù…':'Stocks'}: ${d.data.stocks}`;
    document.getElementById("fee").textContent=`ğŸ§¾ ${lang==='ar'?'Ø§Ù„Ø±Ø³ÙˆÙ…':'Fee'}: ${adminFeeFixed}$ + ${adminFeePercent}%`;
    
    document.getElementById("loadingUser").style.display="none";
    document.getElementById("userData").style.display="block";
  }catch(err){
    console.error("Error:",err);
    showMsg(texts[lang].serverError,false);
    document.getElementById("loadingUser").style.display="none";
    document.getElementById("userData").style.display="block";
  }
}

function prepareAction(t){
  const q=Number(document.getElementById("amount").value);
  if(!q||q<=0) return showMsg(texts[lang].invalidQuantity,false);
  
  const s=q*stockPrice;
  const f=adminFeeFixed+(s*adminFeePercent/100);
  const total=t==="buy"?s+f:s-f;
  
  currentAction=t;
  document.getElementById("confirmBox").style.display="block";
  document.getElementById("confirmText").innerHTML=`
    ${t==="buy"?texts[lang].buy:texts[lang].sell} ${q}<br>
    ${lang==='ar'?'Ø§Ù„Ø³Ø¹Ø±':'Price'}: ${stockPrice.toFixed(6)}$<br>
    ${lang==='ar'?'Ø§Ù„Ø±Ø³ÙˆÙ…':'Fee'}: ${f.toFixed(6)}$<br>
    <b>${lang==='ar'?'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ':'Total'}: ${total.toFixed(6)}$</b>
  `;
}

function cancelAction(){
  document.getElementById("confirmBox").style.display="none";
  currentAction=null;
  document.getElementById("amount").value="";
}

async function confirmAction(){
  const q=Number(document.getElementById("amount").value);
  if(!currentAction||!q||q<=0) return showMsg(texts[lang].invalidQuantity,false);
  
  const url=currentAction==="buy"?"/api/buy-stock":"/api/sell-stock";
  document.getElementById("msg").textContent="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...";
  document.getElementById("msg").className="message";
  
  try{
    const r=await fetch(url,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:telegram_id,quantity:q})});
    const d=await r.json();
    
    if(d.status==="success"){
      showMsg(texts[lang].operationSuccess);
      document.getElementById("amount").value="";
      await loadInvestment();
      await loadTransactions();
    }else showMsg(d.message||"ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©",false);
  }catch(err){
    console.error("Transaction error:",err);
    showMsg(texts[lang].serverError,false);
  }
  cancelAction();
}

async function loadTransactions(){
  try{
    document.getElementById("transactionsLoading").style.display="block";
    document.getElementById("transactionsContent").style.display="none";
    
    const r=await fetch(`/api/transactions?user_id=${telegram_id}`);
    const d=await r.json();
    
    if(d.status!=="success") throw new Error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„");
    
    const t=document.getElementById("txTable");
    t.innerHTML="";
    
    if(d.data.length===0){
      t.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#94a3b8;">${texts[lang].noTransactions}</td></tr>`;
    }else{
      d.data.forEach(x=>{
        t.innerHTML+=`<tr>
          <td>${x.type==='BUY'?(lang==='ar'?'Ø´Ø±Ø§Ø¡':'Buy'):(lang==='ar'?'Ø¨ÙŠØ¹':'Sell')}</td>
          <td>${x.quantity}</td>
          <td>${Number(x.price).toFixed(6)}$</td>
          <td>${Number(x.total).toFixed(6)}$</td>
          <td>${new Date(x.date).toLocaleTimeString(lang==='ar'?'ar-SA':'en-US')}</td>
        </tr>`;
      });
    }
    
    document.getElementById("transactionsLoading").style.display="none";
    document.getElementById("transactionsContent").style.display="block";
  }catch(err){
    console.error("Transactions error:",err);
    document.getElementById("transactionsLoading").textContent=texts[lang].serverError;
  }
}

async function loadChart(){
  try{
    document.getElementById("chartLoading").style.display="block";
    document.getElementById("priceChart").style.display="none";
    
    const r=await fetch('/api/stock-chart');
    const d=await r.json();
    
    if(d.status!=="success"||!d.data||d.data.length===0){
      document.getElementById("chartLoading").textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª";
      return;
    }
    
    if(chartInstance) chartInstance.destroy();
    
    const ctx=document.getElementById("priceChart").getContext('2d');
    chartInstance=new Chart(ctx,{
      type:"line",
      data:{
        labels:d.data.map(x=>new Date(x.date).toLocaleTimeString(lang==='ar'?'ar-SA':'en-US',{hour:'2-digit',minute:'2-digit'})),
        datasets:[{label:lang==='ar'?"Ø§Ù„Ø³Ø¹Ø±":"Price",data:d.data.map(x=>Number(x.price)),borderColor:"#22c55e",backgroundColor:"rgba(34,197,94,0.1)",borderWidth:2,tension:0.3,fill:true}]
      },
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{ticks:{color:'#94a3b8',callback:v=>v.toFixed(6)+'$'}},x:{ticks:{color:'#94a3b8'}}}}
    });
    
    lastPriceCheck=d.data[d.data.length-1].date;
    document.getElementById("chartLoading").style.display="none";
    document.getElementById("priceChart").style.display="block";
  }catch(err){
    console.error("Chart error:",err);
    document.getElementById("chartLoading").textContent=texts[lang].serverError;
  }
}

async function checkPriceUpdate(){
  try{
    const r=await fetch('/api/stock-chart');
    const d=await r.json();
    
    if(d.status==="success"&&d.data.length>0){
      const latest=d.data[d.data.length-1].date;
      if(!lastPriceCheck||latest>lastPriceCheck){
        console.log("ğŸ“ˆ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø³Ø¹Ø±");
        await loadChart();
        await loadInvestment();
        await loadTransactions();
        lastPriceCheck=latest;
      }
    }
  }catch(err){console.error("Price check error:",err)}
}

// Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
Promise.all([loadInvestment(),loadTransactions(),loadChart()]).catch(console.error);
setInterval(checkPriceUpdate,5000);
</script>
</body>
</html>
