<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg-primary:#020617;--bg-secondary:#1e293b;--border-color:#334155;--text-color:#fff;--success-color:#22c55e;--error-color:#ef4444;--warning-color:#475569}
body{background:var(--bg-primary);color:var(--text-color);font-family:'Segoe UI',sans-serif;padding:15px;margin:0}
.container{max-width:1200px;margin:0 auto}
.card{background:var(--bg-secondary);padding:20px;border-radius:12px;margin-bottom:20px;border:1px solid var(--border-color);box-shadow:0 4px 10px rgba(0,0,0,0.2)}
.info-box{background:var(--bg-primary);border:1px solid var(--border-color);padding:15px;border-radius:10px;line-height:1.6;margin-bottom:15px;color:#cbd5e1}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px}
.stat-item{background:rgba(51,65,85,0.3);padding:12px;border-radius:8px;text-align:center;border:1px solid var(--border-color)}
.stat-label{font-size:12px;color:#94a3b8;margin-bottom:5px}
.stat-value{font-size:18px;font-weight:600}
input,button{width:100%;padding:12px;margin-top:12px;border-radius:8px;border:none;font-size:15px}
input{background:var(--bg-primary);color:var(--text-color);border:1px solid var(--border-color)}
input:focus{outline:2px solid var(--success-color);border-color:var(--success-color)}
button{cursor:pointer;font-weight:600;transition:all 0.2s}
button:hover{opacity:0.9}
.buy-btn{background:#22c55e;color:white}
.sell-btn{background:#ef4444;color:white}
.cancel-btn{background:#475569;color:white}
.message-box{margin-top:15px;padding:12px;border-radius:6px;font-weight:bold;text-align:center;display:none}
.success{color:#22c55e;background:rgba(34,197,94,0.1);border:1px solid #22c55e}
.error{color:#ef4444;background:rgba(239,68,68,0.1);border:1px solid #ef4444}
table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
th,td{border:1px solid var(--border-color);padding:10px;text-align:center}
th{background:var(--border-color);color:white;font-weight:600}
.loading{text-align:center;padding:25px;color:#94a3b8;font-size:16px}
.chart-container{height:250px;width:100%}
.lang-switcher{display:flex;justify-content:flex-end;margin-bottom:15px;gap:10px}
.lang-btn{background:var(--bg-primary);color:var(--text-color);border:1px solid var(--border-color);padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px}
.lang-btn.active{background:#22c55e;border-color:#22c55e;color:white}
</style>
</head>
<body>
<div class="container">
  <!-- Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© -->
  <div class="lang-switcher">
    <button class="lang-btn active" onclick="switchLang('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    <button class="lang-btn" onclick="switchLang('en')">English</button>
  </div>

  <h1 id="title">ğŸ“ˆ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</h1>
  
  <div class="card">
    <div class="info-box" id="info">
      ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§. Ø§Ù„Ø³Ø¹Ø± ÙŠØ±ØªÙØ¹ ÙˆÙŠÙ†Ø®ÙØ¶ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆÙ‚.<br>
      Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: 0.05$ + 2% Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©.
    </div>
  </div>

  <div class="card">
    <div id="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    <div id="content" style="display:none">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">ğŸ‘¤ Ø§Ù„Ù…Ø¹Ø±Ù</div>
          <div class="stat-value" id="userId">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ğŸ’° Ø§Ù„Ø³Ø¹Ø±</div>
          <div class="stat-value" id="price">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ğŸ’µ Ø§Ù„Ø±ØµÙŠØ¯</div>
          <div class="stat-value" id="balance">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ğŸ“¦ Ø§Ù„Ø£Ø³Ù‡Ù…</div>
          <div class="stat-value" id="stocks">--</div>
        </div>
      </div>
      
      <div class="info-box" id="feeInfo">ğŸ§¾ Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: <span id="feeValue">0.05$ + 2%</span></div>
      
      <input id="amount" type="number" min="1" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px">
        <button class="buy-btn" onclick="buy()">ğŸ›’ Ø´Ø±Ø§Ø¡</button>
        <button class="sell-btn" onclick="sell()">ğŸ’¸ Ø¨ÙŠØ¹</button>
      </div>
      <div id="msg" class="message-box"></div>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ“Š Ù…Ø®Ø·Ø· Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù…</h2>
    <div class="loading" id="chartLoad">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·...</div>
    <div class="chart-container" id="chartBox" style="display:none">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ“‘ Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª</h2>
    <div class="loading" id="txLoad">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø§Øª...</div>
    <div id="txContent" style="display:none">
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ÙˆÙ‚Øª</th>
            </tr>
          </thead>
          <tbody id="txTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
const params = new URLSearchParams(location.search);
const userId = params.get('user_id') || '123456';
let lang = params.get('lang') || 'ar';
let currentPrice = 1.00;
let chartInstance = null;

// Ø§Ù„Ù†ØµÙˆØµ
const texts = {
  ar: {
    title: "ğŸ“ˆ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±",
    info: "ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§. Ø§Ù„Ø³Ø¹Ø± ÙŠØ±ØªÙØ¹ ÙˆÙŠÙ†Ø®ÙØ¶ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆÙ‚.<br>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: 0.05$ + 2% Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©.",
    buyBtn: "ğŸ›’ Ø´Ø±Ø§Ø¡", sellBtn: "ğŸ’¸ Ø¨ÙŠØ¹", placeholder: "Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…",
    loading: "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...", success: "âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­", error: "âŒ ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©",
    type: "Ø§Ù„Ù†ÙˆØ¹", qty: "Ø§Ù„ÙƒÙ…ÙŠØ©", price: "Ø§Ù„Ø³Ø¹Ø±", total: "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", date: "Ø§Ù„ÙˆÙ‚Øª", noTx: "Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª"
  },
  en: {
    title: "ğŸ“ˆ Investment System",
    info: "Buy and hold stocks. Price fluctuates based on market.<br>Admin fee: 0.05$ + 2% per transaction.",
    buyBtn: "ğŸ›’ Buy", sellBtn: "ğŸ’¸ Sell", placeholder: "Enter quantity",
    loading: "â³ Loading...", success: "âœ… Operation successful", error: "âŒ Operation failed",
    type: "Type", qty: "Qty", price: "Price", total: "Total", date: "Time", noTx: "No transactions"
  }
};

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ØºØ©
function switchLang(newLang) {
  lang = newLang;
  document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.lang-btn:nth-child(${lang === 'ar' ? 1 : 2})`).classList.add('active');
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
  document.getElementById('title').textContent = texts[lang].title;
  document.getElementById('info').innerHTML = texts[lang].info;
  document.querySelector('.buy-btn').innerHTML = texts[lang].buyBtn;
  document.querySelector('.sell-btn').innerHTML = texts[lang].sellBtn;
  document.getElementById('amount').placeholder = texts[lang].placeholder;
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  loadData();
  loadTransactions();
  loadChart();
}

// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
function showMessage(text, isSuccess = true) {
  const msg = document.getElementById('msg');
  msg.textContent = text;
  msg.className = `message-box ${isSuccess ? 'success' : 'error'}`;
  msg.style.display = 'block';
  setTimeout(() => msg.style.display = 'none', 4000);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function loadData() {
  try {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('content').style.display = 'none';
    
    const res = await fetch(`/api/investment-data?user_id=${userId}`);
    const data = await res.json();
    
    if (data.status === 'success') {
      document.getElementById('userId').textContent = userId;
      document.getElementById('price').textContent = `${Number(data.data.price).toFixed(6)}$`;
      document.getElementById('balance').textContent = `${Number(data.data.balance).toFixed(6)}$`;
      document.getElementById('stocks').textContent = data.data.stocks || 0;
      document.getElementById('feeValue').textContent = `${data.data.admin_fee_fixed}$ + ${data.data.admin_fee_percent}%`;
      currentPrice = Number(data.data.price);
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    } else {
      throw new Error(data.message || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
    }
  } catch (err) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', err);
    document.getElementById('loading').innerHTML = `âŒ ${texts[lang].error}: ${err.message || 'Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±'}`;
  }
}

// Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù…
async function buy() {
  const qty = parseInt(document.getElementById('amount').value);
  if (!qty || qty <= 0) return showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©', false);
  
  try {
    const res = await fetch('/api/buy-stock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, quantity: qty })
    });
    const data = await res.json();
    
    if (data.status === 'success') {
      showMessage(texts[lang].success);
      document.getElementById('amount').value = '';
      loadData();
      loadTransactions();
    } else {
      showMessage(data.message || texts[lang].error, false);
    }
  } catch (err) {
    console.error('âŒ Ø®Ø·Ø£ Ø§Ù„Ø´Ø±Ø§Ø¡:', err);
    showMessage(texts[lang].error, false);
  }
}

// Ø¨ÙŠØ¹ Ø§Ù„Ø£Ø³Ù‡Ù…
async function sell() {
  const qty = parseInt(document.getElementById('amount').value);
  if (!qty || qty <= 0) return showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©', false);
  
  try {
    const res = await fetch('/api/sell-stock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, quantity: qty })
    });
    const data = await res.json();
    
    if (data.status === 'success') {
      showMessage(texts[lang].success);
      document.getElementById('amount').value = '';
      loadData();
      loadTransactions();
    } else {
      showMessage(data.message || texts[lang].error, false);
    }
  } catch (err) {
    console.error('âŒ Ø®Ø·Ø£ Ø§Ù„Ø¨ÙŠØ¹:', err);
    showMessage(texts[lang].error, false);
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„
async function loadTransactions() {
  try {
    document.getElementById('txLoad').style.display = 'block';
    document.getElementById('txContent').style.display = 'none';
    
    const res = await fetch(`/api/transactions?user_id=${userId}`);
    const data = await res.json();
    
    if (data.status === 'success') {
      const table = document.getElementById('txTable');
      table.innerHTML = '';
      
      if (data.data.length === 0) {
        table.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#94a3b8;padding:20px">${texts[lang].noTx}</td></tr>`;
      } else {
        data.data.slice(0, 10).forEach(tx => {
          const isBuy = tx.type === 'BUY';
          const typeText = isBuy ? (lang === 'ar' ? 'Ø´Ø±Ø§Ø¡' : 'Buy') : (lang === 'ar' ? 'Ø¨ÙŠØ¹' : 'Sell');
          const color = isBuy ? '#22c55e' : '#ef4444';
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td style="color:${color};font-weight:bold">${typeText}</td>
            <td>${tx.quantity}</td>
            <td>${Number(tx.price).toFixed(6)}$</td>
            <td style="color:${color}">${Number(tx.total).toFixed(6)}$</td>
            <td>${new Date(tx.date).toLocaleTimeString(lang === 'ar' ? 'ar-SA' : 'en-US', {hour:'2-digit',minute:'2-digit'})}</td>
          `;
          table.appendChild(row);
        });
      }
      
      document.getElementById('txLoad').style.display = 'none';
      document.getElementById('txContent').style.display = 'block';
    }
  } catch (err) {
    console.error('âŒ Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„:', err);
    document.getElementById('txLoad').textContent = texts[lang].error;
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·
async function loadChart() {
  try {
    document.getElementById('chartLoad').style.display = 'block';
    document.getElementById('chartBox').style.display = 'none';
    
    const res = await fetch('/api/stock-chart');
    const data = await res.json();
    
    if (data.status === 'success' && data.data.length > 0) {
      if (chartInstance) chartInstance.destroy();
      
      const ctx = document.getElementById('chart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'line',
        : {
          labels: data.data.map(d => new Date(d.date).toLocaleTimeString(lang === 'ar' ? 'ar-SA' : 'en-US', {hour:'2-digit',minute:'2-digit'})),
          datasets: [{
            label: lang === 'ar' ? 'Ø§Ù„Ø³Ø¹Ø±' : 'Price',
            data: data.data.map(d => Number(d.price)),
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34,197,94,0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { 
              ticks: { 
                color: '#94a3b8', 
                callback: v => v.toFixed(6) + '$' 
              },
              grid: { color: 'rgba(51,65,85,0.3)' }
            },
            x: { 
              ticks: { color: '#94a3b8' },
              grid: { color: 'rgba(51,65,85,0.3)' }
            }
          }
        }
      });
      
      document.getElementById('chartLoad').style.display = 'none';
      document.getElementById('chartBox').style.display = 'block';
    }
  } catch (err) {
    console.error('âŒ Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·:', err);
    document.getElementById('chartLoad').textContent = texts[lang].error;
  }
}

// Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
document.addEventListener('DOMContentLoaded', () => {
  switchLang(lang); // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ØºØ©
  
  // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
  setInterval(() => {
    loadData();
    loadTransactions();
  }, 10000);
});
</script>
</body>
</html>
