<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Investment</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  background:#020617;
  color:#fff;
  font-family:Arial;
  padding:20px;
}
.card{
  background:#1e293b;
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;
}
.info{
  background:#020617;
  border:1px solid #334155;
  padding:12px;
  border-radius:10px;
  line-height:1.6;
  font-size:14px;
}
input,button{
  width:100%;
  padding:10px;
  margin-top:10px;
  border-radius:6px;
  border:none;
}
input{
  background:#020617;
  color:#fff;
  border:1px solid #334155;
}
button{
  font-size:16px;
  cursor:pointer;
}
.buy{ background:#22c55e; }
.sell{ background:#ef4444; }
.cancel{ background:#475569; }

.message{
  margin-top:10px;
  font-weight:bold;
}
.success{ color:#22c55e; }
.error{ color:#ef4444; }

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  border:1px solid #334155;
  padding:6px;
}
th{ background:#334155; }
</style>
</head>

<body>

<h2 id="title">ğŸ“ˆ Investment</h2>

<!-- Ø´Ø±Ø­ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± -->
<div class="info" id="investmentInfo"></div>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
<div class="card">
  <p id="price">ğŸ’° Price: --</p>
  <p id="balance">ğŸ’µ Balance: --</p>
  <p id="stocks">ğŸ“¦ My Stocks: --</p>
  <p id="fee">ğŸ§¾ Admin Fee: 0.05$ + 2%</p>

  <input id="amount" type="number" min="1" placeholder="Enter stocks amount">

  <button class="buy" onclick="prepareAction('buy')">ğŸ›’ Buy</button>
  <button class="sell" onclick="prepareAction('sell')">ğŸ’¸ Sell</button>

  <div id="msg" class="message"></div>
</div>

<!-- ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© -->
<div class="card" id="confirmBox" style="display:none;">
  <div id="confirmText"></div>
  <button class="buy" onclick="confirmAction()">âœ… Confirm</button>
  <button class="cancel" onclick="cancelAction()">âŒ Cancel</button>
</div>

<!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
<div class="card">
  <h3>ğŸ“Š Stock Price Chart</h3>
  <canvas id="priceChart" height="120"></canvas>
</div>

<!-- Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª -->
<div class="card">
  <h3>ğŸ“‘ Transactions</h3>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="txTable"></tbody>
  </table>
</div>

<script>
/* ===================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===================== */
const params = new URLSearchParams(location.search);
const telegram_id = params.get('telegram_id');
const lang = params.get('lang') || 'en';

let stockPrice = 0;
let currentAction = null;

/* ===================== Ø§Ù„Ù†ØµÙˆØµ ===================== */
const texts = {
  ar:{
    title:"ğŸ“ˆ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ",
    info:`ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§ØŒ Ø­ÙŠØ« ÙŠØ±ØªÙØ¹ ÙˆÙŠÙ†Ø®ÙØ¶ Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù… Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆÙ‚.<br>
    Ù†Ø­Ù† Ù†Ø¹Ù…Ù„ ÙÙŠ Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¨ÙŠØ¹ Ø£Ø³Ù‡Ù…Ùƒ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.<br>
    Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ¹ ÙŠØªÙ… Ø®ØµÙ… Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.`,
    buy:"Ø´Ø±Ø§Ø¡",
    sell:"Ø¨ÙŠØ¹"
  },
  en:{
    title:"ğŸ“ˆ My Investment",
    info:`You can buy stocks and hold them while prices rise and fall based on the market.<br>
    We operate long-term investment strategies, and you can sell your stocks at any time.<br>
    An administration fee applies on every buy or sell operation.`,
    buy:"Buy",
    sell:"Sell"
  }
};

document.getElementById("title").innerText = texts[lang].title;
document.getElementById("investmentInfo").innerHTML = texts[lang].info;

/* ===================== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===================== */
function showMsg(text, ok=true){
  const m = document.getElementById("msg");
  m.textContent = text;
  m.className = "message " + (ok ? "success" : "error");
}

/* ===================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===================== */
async function loadInvestment(){
  const r = await fetch(`/api/investment-data?telegram_id=${telegram_id}`);
  const d = await r.json();

  stockPrice = Number(d.price);

  document.getElementById("price").textContent =
    `ğŸ’° Price: ${stockPrice.toFixed(6)}$`;
  document.getElementById("balance").textContent =
    `ğŸ’µ Balance: ${Number(d.balance).toFixed(6)}$`;
  document.getElementById("stocks").textContent =
    `ğŸ“¦ My Stocks: ${d.stocks}`;
}

/* ===================== ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ===================== */
function prepareAction(type){
  const qty = Number(amount.value);
  if(qty <= 0) return showMsg("Invalid quantity", false);

  const subtotal = qty * stockPrice;
  const fee = 0.05 + (subtotal * 0.02);
  const total = type === "buy" ? subtotal + fee : subtotal - fee;

  currentAction = type;
  confirmBox.style.display = "block";
  confirmText.innerHTML = `
    ${type === "buy" ? texts[lang].buy : texts[lang].sell} ${qty} stocks<br>
    Price: ${stockPrice}$<br>
    Subtotal: ${subtotal.toFixed(6)}$<br>
    Admin Fee: ${fee.toFixed(6)}$<br>
    <b>Total: ${total.toFixed(6)}$</b>
  `;
}

function cancelAction(){
  confirmBox.style.display = "none";
  currentAction = null;
}

/* ===================== ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ===================== */
async function confirmAction(){
  const qty = Number(amount.value);
  const url = currentAction === "buy" ? "/api/buy-stock" : "/api/sell-stock";

  const r = await fetch(url,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ telegram_id, amount: qty })
  });

  const d = await r.json();

  if(d.success){
    showMsg("Operation completed successfully");
    loadInvestment();
    loadTransactions();
  }else{
    showMsg(d.message || "Operation failed", false);
  }

  cancelAction();
}

/* ===================== Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª ===================== */
async function loadTransactions(){
  const r = await fetch(`/api/transactions?telegram_id=${telegram_id}`);
  const data = await r.json();

  txTable.innerHTML = "";
  data.forEach(t=>{
    txTable.innerHTML += `
      <tr>
        <td>${t.type}</td>
        <td>${t.qty}</td>
        <td>${t.price}</td>
        <td>${t.total}</td>
        <td>${t.date}</td>
      </tr>
    `;
  });
}

/* ===================== Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ===================== */
async function loadChart(){
  const r = await fetch('/api/stock-chart');
  const data = await r.json();

  new Chart(document.getElementById("priceChart"),{
    type:"line",
    data:{
      labels:data.map(d=>d.date),
      datasets:[{
        data:data.map(d=>d.price),
        borderWidth:2,
        tension:0.4
      }]
    },
    options:{
      plugins:{ legend:{display:false} },
      scales:{
        y:{
          ticks:{ callback:v=>v.toFixed(6) }
        }
      }
    }
  });
}

/* ===================== ØªØ´ØºÙŠÙ„ ===================== */
loadInvestment();
loadTransactions();
loadChart();
</script>

</body>
</html>
