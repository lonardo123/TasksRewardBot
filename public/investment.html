<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Investment</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  background:#020617;
  color:#fff;
  font-family:Arial;
  padding:20px;
}
.card{
  background:#1e293b;
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;
}
.info{
  background:#020617;
  border:1px solid #334155;
  padding:12px;
  border-radius:10px;
  line-height:1.6;
  font-size:14px;
}
input,button{
  width:100%;
  padding:10px;
  margin-top:10px;
  border-radius:6px;
  border:none;
}
input{
  background:#020617;
  color:#fff;
  border:1px solid #334155;
}
button{ font-size:16px; cursor:pointer; }
.buy{ background:#22c55e; }
.sell{ background:#ef4444; }
.cancel{ background:#475569; }

.message{ margin-top:10px; font-weight:bold; }
.success{ color:#22c55e; }
.error{ color:#ef4444; }

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  border:1px solid #334155;
  padding:6px;
}
th{ background:#334155; }
</style>
</head>

<body>

<h2 id="title">ğŸ“ˆ Investment</h2>

<!-- Ø´Ø±Ø­ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± -->
<div class="info" id="investmentInfo"></div>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
<div class="card">
  <p id="userId">ğŸ‘¤ User ID: --</p>
  <p id="price">ğŸ’° Price: --</p>
  <p id="balance">ğŸ’µ Balance: --</p>
  <p id="stocks">ğŸ“¦ My Stocks: --</p>
  <p>ğŸ§¾ Admin Fee: 0.05$ + 2%</p>

  <input id="qty" type="number" min="1" placeholder="Enter stocks amount">

  <button class="buy" onclick="prepareAction('buy')">ğŸ›’ Buy</button>
  <button class="sell" onclick="prepareAction('sell')">ğŸ’¸ Sell</button>

  <div id="msg" class="message"></div>
</div>

<!-- ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© -->
<div class="card" id="confirmBox" style="display:none;">
  <div id="confirmText"></div>
  <button class="buy" onclick="confirmAction()">âœ… Confirm</button>
  <button class="cancel" onclick="cancelAction()">âŒ Cancel</button>
</div>

<!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
<div class="card">
  <h3>ğŸ“Š Stock Price Chart</h3>
  <canvas id="priceChart" height="120"></canvas>
</div>

<!-- Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª -->
<div class="card">
  <h3>ğŸ“‘ Transactions</h3>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="txTable"></tbody>
  </table>
</div>

<script>
/* ===================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===================== */
const params = new URLSearchParams(location.search);
const user_id = params.get('user_id');
const lang = params.get('lang') || 'en';

let stockPrice = 0;
let currentAction = null;

/* ===================== Ø§Ù„Ù†ØµÙˆØµ ===================== */
const texts = {
  ar:{
    title:"ğŸ“ˆ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ",
    info:`ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§ØŒ Ø­ÙŠØ« ÙŠØ±ØªÙØ¹ ÙˆÙŠÙ†Ø®ÙØ¶ Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù… Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆÙ‚.<br>
    Ù†Ø­Ù† Ù†Ø¹Ù…Ù„ ÙÙŠ Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¨ÙŠØ¹ Ø£Ø³Ù‡Ù…Ùƒ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.<br>
    Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ¹ ÙŠØªÙ… Ø®ØµÙ… Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.`,
    buy:"Ø´Ø±Ø§Ø¡",
    sell:"Ø¨ÙŠØ¹",
    success:"ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­"
  },
  en:{
    title:"ğŸ“ˆ My Investment",
    info:`You can buy stocks and hold them while prices rise and fall based on the market.<br>
    We operate long-term investment strategies, and you can sell your stocks at any time.<br>
    An administration fee applies on every buy or sell operation.`,
    buy:"Buy",
    sell:"Sell",
    success:"Operation completed successfully"
  }
};

title.innerText = texts[lang].title;
investmentInfo.innerHTML = texts[lang].info;

/* ===================== Ø±Ø³Ø§Ø¦Ù„ ===================== */
function showMsg(text, ok=true){
  msg.textContent = text;
  msg.className = "message " + (ok ? "success" : "error");
}

/* ===================== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===================== */
async function loadProfile(){
  const r = await fetch(`/api/user/profile?user_id=${user_id}`);
  const d = await r.json();

  if(d.status === "success"){
    userId.textContent = `ğŸ‘¤ User ID: ${d.data.user_id}`;
    balance.textContent = `ğŸ’µ Balance: ${d.data.balance.toFixed(6)}$`;
  }
}

/* ===================== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ===================== */
async function loadInvestment(){
  const r = await fetch(`/api/investment-data?user_id=${user_id}`);
  const d = await r.json();

  stockPrice = Number(d.price);

  price.textContent = `ğŸ’° Price: ${stockPrice.toFixed(6)}$`;
  stocks.textContent = `ğŸ“¦ My Stocks: ${d.stocks}`;
}

/* ===================== ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ===================== */
function prepareAction(type){
  const q = Number(qty.value);
  if(q <= 0) return showMsg("Invalid quantity", false);

  const subtotal = q * stockPrice;
  const fee = 0.05 + (subtotal * 0.02);
  const total = type === "buy" ? subtotal + fee : subtotal - fee;

  currentAction = type;
  confirmBox.style.display = "block";
  confirmText.innerHTML = `
    <b>${type === "buy" ? texts[lang].buy : texts[lang].sell}</b><br>
    Qty: ${q}<br>
    Price: ${stockPrice.toFixed(6)}$<br>
    Subtotal: ${subtotal.toFixed(6)}$<br>
    Fee: ${fee.toFixed(6)}$<br>
    <b>Total: ${total.toFixed(6)}$</b>
  `;
}

function cancelAction(){
  confirmBox.style.display = "none";
  currentAction = null;
}

/* ===================== ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ===================== */
async function confirmAction(){
  const q = Number(qty.value);
  const url = currentAction === "buy" ? "/api/buy-stock" : "/api/sell-stock";

  const r = await fetch(url,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ user_id, quantity: q })
  });

  const d = await r.json();

  if(d.status === "success" || d.success){
    showMsg(texts[lang].success);
    await loadProfile();   // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ÙŠÙ
    await loadInvestment();
    await loadTransactions();
  }else{
    showMsg(d.message || "Operation failed", false);
  }

  cancelAction();
}

/* ===================== Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª ===================== */
async function loadTransactions(){
  const r = await fetch(`/api/transactions?user_id=${user_id}`);
  const d = await r.json();

  txTable.innerHTML = "";
  if(d.status !== "success") return;

  d.data.forEach(t=>{
    txTable.innerHTML += `
      <tr>
        <td>${t.type}</td>
        <td>${t.quantity}</td>
        <td>${t.price.toFixed(6)}</td>
        <td>${t.total.toFixed(6)}</td>
        <td>${new Date(t.date).toLocaleString()}</td>
      </tr>
    `;
  });
}

/* ===================== Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ===================== */
async function loadChart(){
  const r = await fetch('/api/stock-chart');
  const d = await r.json();

  new Chart(priceChart,{
    type:"line",
    data:{
      labels:d.data.map(x=>x.date),
      datasets:[{
        data:d.data.map(x=>x.price),
        borderWidth:2,
        tension:0.4
      }]
    },
    options:{
      plugins:{ legend:{display:false} },
      scales:{ y:{ ticks:{ callback:v=>v.toFixed(6) } } }
    }
  });
}

/* ===================== ØªØ´ØºÙŠÙ„ ===================== */
loadProfile();
loadInvestment();
loadTransactions();
loadChart();
</script>

</body>
</html>
