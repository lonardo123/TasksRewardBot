<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg-primary:#020617;--bg-secondary:#1e293b;--border-color:#334155;--text-color:#fff;--success-color:#22c55e;--error-color:#ef4444;--warning-color:#475569}
body{background:var(--bg-primary);color:var(--text-color);font-family:'Segoe UI',sans-serif;padding:15px}
.container{max-width:1200px;margin:0 auto}
.card{background:var(--bg-secondary);padding:20px;border-radius:12px;margin-bottom:20px;border:1px solid var(--border-color)}
.info-box{background:var(--bg-primary);border:1px solid var(--border-color);padding:15px;border-radius:10px;line-height:1.6;margin-bottom:15px;color:#cbd5e1}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px}
.stat-item{background:rgba(51,65,85,0.3);padding:12px;border-radius:8px;text-align:center;border:1px solid var(--border-color)}
.stat-label{font-size:12px;color:#94a3b8;margin-bottom:5px}
.stat-value{font-size:18px;font-weight:600}
input,button{width:100%;padding:12px;margin-top:12px;border-radius:8px;border:none;font-size:15px}
input{background:var(--bg-primary);color:var(--text-color);border:1px solid var(--border-color)}
button{cursor:pointer;font-weight:600}
.buy-btn{background:#22c55e;color:white}
.sell-btn{background:#ef4444;color:white}
.cancel-btn{background:#475569;color:white}
.message-box{margin-top:15px;padding:12px;border-radius:6px;font-weight:bold;text-align:center;display:none}
.success{color:#22c55e;background:rgba(34,197,94,0.1);border:1px solid #22c55e}
.error{color:#ef4444;background:rgba(239,68,68,0.1);border:1px solid #ef4444}
table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
th,td{border:1px solid var(--border-color);padding:10px;text-align:center}
th{background:var(--border-color);color:white;font-weight:600}
.loading{text-align:center;padding:25px;color:#94a3b8;font-size:14px}
.chart-container{height:220px;width:100%}
.lang-switcher{display:flex;justify-content:flex-end;margin-bottom:15px;gap:10px}
.lang-btn{background:var(--bg-primary);color:var(--text-color);border:1px solid var(--border-color);padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px}
.lang-btn.active{background:#22c55e;border-color:#22c55e;color:white}
</style>
</head>
<body>
<div class="container">
  <div class="lang-switcher">
    <button class="lang-btn active" onclick="switchLang('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    <button class="lang-btn" onclick="switchLang('en')">English</button>
  </div>

  <h1 id="title">ğŸ“ˆ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</h1>
  
  <div class="card">
    <div class="info-box" id="info">
      ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§. Ø§Ù„Ø³Ø¹Ø± ÙŠØ±ØªÙØ¹ ÙˆÙŠÙ†Ø®ÙØ¶ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆÙ‚.<br>
      Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: 0.05$ + 2% Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©.
    </div>
  </div>

  <div class="card">
    <div id="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    <div id="content" style="display:none">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">ğŸ‘¤ Ø§Ù„Ù…Ø¹Ø±Ù</div>
          <div class="stat-value" id="userId">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ğŸ’° Ø§Ù„Ø³Ø¹Ø±</div>
          <div class="stat-value" id="price">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ğŸ’µ Ø§Ù„Ø±ØµÙŠØ¯</div>
          <div class="stat-value" id="balance">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ğŸ“¦ Ø§Ù„Ø£Ø³Ù‡Ù…</div>
          <div class="stat-value" id="stocks">--</div>
        </div>
      </div>
      
      <input id="amount" type="number" min="1" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
        <button class="buy-btn" onclick="buy()">ğŸ›’ Ø´Ø±Ø§Ø¡</button>
        <button class="sell-btn" onclick="sell()">ğŸ’¸ Ø¨ÙŠØ¹</button>
      </div>
      <div id="msg" class="message-box"></div>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ“Š Ø§Ù„Ù…Ø®Ø·Ø·</h2>
    <div class="loading" id="chartLoad">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <div class="chart-container" id="chartBox" style="display:none">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ“‘ Ø§Ù„Ø³Ø¬Ù„</h2>
    <div class="loading" id="txLoad">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <div id="txContent" style="display:none">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ÙˆÙ‚Øª</th>
          </tr>
        </thead>
        <tbody id="txTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
const urlParams = new URLSearchParams(window.location.search);
const userId = urlParams.get('user_id') || '123456';
let lang = urlParams.get('lang') || 'ar';
let price = 1.00;
let chart = null;

// Ø§Ù„Ù†ØµÙˆØµ
const txt = {
  ar: {
    title: "ğŸ“ˆ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±",
    info: "ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§. Ø§Ù„Ø³Ø¹Ø± ÙŠØ±ØªÙØ¹ ÙˆÙŠÙ†Ø®ÙØ¶ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆÙ‚.<br>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: 0.05$ + 2% Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©.",
    buy: "Ø´Ø±Ø§Ø¡", sell: "Ø¨ÙŠØ¹", buyBtn: "ğŸ›’ Ø´Ø±Ø§Ø¡", sellBtn: "ğŸ’¸ Ø¨ÙŠØ¹",
    placeholder: "Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©", loading: "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
    success: "âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­", error: "âŒ ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"
  },
  en: {
    title: "ğŸ“ˆ Investment System",
    info: "Buy and hold stocks. Price fluctuates based on market.<br>Admin fee: 0.05$ + 2% per transaction.",
    buy: "Buy", sell: "Sell", buyBtn: "ğŸ›’ Buy", sellBtn: "ğŸ’¸ Sell",
    placeholder: "Enter quantity", loading: "â³ Loading...",
    success: "âœ… Operation successful", error: "âŒ Operation failed"
  }
};

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ØºØ©
function switchLang(newLang) {
  lang = newLang;
  document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
  if(lang === 'ar') document.querySelector('.lang-btn:nth-child(1)').classList.add('active');
  else document.querySelector('.lang-btn:nth-child(2)').classList.add('active');
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
  document.getElementById('title').textContent = txt[lang].title;
  document.getElementById('info').innerHTML = txt[lang].info;
  document.querySelector('.buy-btn').innerHTML = txt[lang].buyBtn;
  document.querySelector('.sell-btn').innerHTML = txt[lang].sellBtn;
  document.getElementById('amount').placeholder = txt[lang].placeholder;
}

// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
function msg(text, ok=true) {
  const m = document.getElementById('msg');
  m.textContent = text;
  m.className = `message-box ${ok ? 'success' : 'error'}`;
  m.style.display = 'block';
  setTimeout(() => m.style.display = 'none', 4000);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function load() {
  try {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù†ÙØ³ Ø§Ù„Ù†Ø·Ø§Ù‚)
    const res = await fetch(`/api/investment-data?user_id=${userId}`);
    const data = await res.json();
    
    if(data.status === 'success') {
      document.getElementById('userId').textContent = userId;
      document.getElementById('price').textContent = `${Number(data.data.price).toFixed(6)}$`;
      document.getElementById('balance').textContent = `${Number(data.data.balance).toFixed(6)}$`;
      document.getElementById('stocks').textContent = data.data.stocks || 0;
      price = Number(data.data.price);
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }
  } catch(e) {
    console.error('ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', e);
    document.getElementById('loading').innerHTML = 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±';
  }
}

// Ø´Ø±Ø§Ø¡
async function buy() {
  const qty = parseInt(document.getElementById('amount').value);
  if(!qty || qty <= 0) return msg('Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©', false);
  
  try {
    const res = await fetch('/api/buy-stock', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({user_id: userId, quantity: qty})
    });
    const data = await res.json();
    
    if(data.status === 'success') {
      msg(txt[lang].success);
      document.getElementById('amount').value = '';
      load();
      loadTransactions();
    } else {
      msg(data.message || txt[lang].error, false);
    }
  } catch(e) {
    msg(txt[lang].error, false);
    console.error('Ø®Ø·Ø£ Ø§Ù„Ø´Ø±Ø§Ø¡:', e);
  }
}

// Ø¨ÙŠØ¹
async function sell() {
  const qty = parseInt(document.getElementById('amount').value);
  if(!qty || qty <= 0) return msg('Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©', false);
  
  try {
    const res = await fetch('/api/sell-stock', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({user_id: userId, quantity: qty})
    });
    const data = await res.json();
    
    if(data.status === 'success') {
      msg(txt[lang].success);
      document.getElementById('amount').value = '';
      load();
      loadTransactions();
    } else {
      msg(data.message || txt[lang].error, false);
    }
  } catch(e) {
    msg(txt[lang].error, false);
    console.error('Ø®Ø·Ø£ Ø§Ù„Ø¨ÙŠØ¹:', e);
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„
async function loadTransactions() {
  try {
    const res = await fetch(`/api/transactions?user_id=${userId}`);
    const data = await res.json();
    
    if(data.status === 'success') {
      const table = document.getElementById('txTable');
      table.innerHTML = '';
      
      if(data.data.length === 0) {
        table.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#94a3b8">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª</td></tr>`;
      } else {
        data.data.slice(0,10).forEach(tx => {
          const type = tx.type === 'BUY' ? (lang === 'ar' ? 'Ø´Ø±Ø§Ø¡' : 'Buy') : (lang === 'ar' ? 'Ø¨ÙŠØ¹' : 'Sell');
          const color = tx.type === 'BUY' ? '#22c55e' : '#ef4444';
          
          table.innerHTML += `
            <tr>
              <td style="color:${color};font-weight:bold">${type}</td>
              <td>${tx.quantity}</td>
              <td>${Number(tx.price).toFixed(6)}$</td>
              <td style="color:${color}">${Number(tx.total).toFixed(6)}$</td>
              <td>${new Date(tx.date).toLocaleTimeString(lang === 'ar' ? 'ar-SA' : 'en-US')}</td>
            </tr>
          `;
        });
      }
      
      document.getElementById('txLoad').style.display = 'none';
      document.getElementById('txContent').style.display = 'block';
    }
  } catch(e) {
    console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„:', e);
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·
async function loadChart() {
  try {
    const res = await fetch('/api/stock-chart');
    const data = await res.json();
    
    if(data.status === 'success' && data.data.length > 0) {
      if(chart) chart.destroy();
      
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        : {
          labels: data.data.map(d => new Date(d.date).toLocaleTimeString(lang === 'ar' ? 'ar-SA' : 'en-US', {hour:'2-digit',minute:'2-digit'})),
          datasets: [{
            label: lang === 'ar' ? 'Ø§Ù„Ø³Ø¹Ø±' : 'Price',
            data: data.data.map(d => Number(d.price)),
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34,197,94,0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {legend: {display: false}},
          scales: {
            y: {ticks: {color: '#94a3b8', callback: v => v.toFixed(6) + '$'}},
            x: {ticks: {color: '#94a3b8'}}
          }
        }
      });
      
      document.getElementById('chartLoad').style.display = 'none';
      document.getElementById('chartBox').style.display = 'block';
    }
  } catch(e) {
    console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·:', e);
  }
}

// Ø§Ù„ØªØ´ØºÙŠÙ„
document.addEventListener('DOMContentLoaded', () => {
  switchLang(lang);
  load();
  loadTransactions();
  loadChart();
  
  // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
  setInterval(() => {
    load();
    loadTransactions();
  }, 10000);
});
</script>
</body>
</html>
