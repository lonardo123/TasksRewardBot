<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg-primary: #020617;
  --bg-secondary: #1e293b;
  --border-color: #334155;
  --text-color: #fff;
  --success-color: #22c55e;
  --error-color: #ef4444;
  --warning-color: #475569;
  --info-color: #3b82f6;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: var(--bg-primary);
  color: var(--text-color);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  padding: 15px;
  line-height: 1.6;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

h1, h2, h3 {
  margin-bottom: 15px;
  font-weight: 600;
}

.card {
  background: var(--bg-secondary);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border: 1px solid var(--border-color);
}

.info-box {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  padding: 15px;
  border-radius: 10px;
  line-height: 1.7;
  font-size: 14px;
  margin-bottom: 15px;
  color: #cbd5e1;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.stat-item {
  background: rgba(51, 65, 85, 0.3);
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  border: 1px solid var(--border-color);
}

.stat-label {
  font-size: 12px;
  color: #94a3b8;
  margin-bottom: 5px;
}

.stat-value {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-color);
}

input, button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 8px;
  border: none;
  font-size: 15px;
  transition: all 0.3s ease;
}

input {
  background: var(--bg-primary);
  color: var(--text-color);
  border: 1px solid var(--border-color);
}

input:focus {
  outline: 2px solid var(--success-color);
  border-color: var(--success-color);
}

button {
  cursor: pointer;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  font-size: 14px;
}

button:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

.buy-btn {
  background: var(--success-color);
  color: white;
}

.sell-btn {
  background: var(--error-color);
  color: white;
}

.cancel-btn {
  background: var(--warning-color);
  color: white;
}

.message-box {
  margin-top: 15px;
  padding: 12px;
  border-radius: 6px;
  font-weight: bold;
  text-align: center;
  font-size: 14px;
}

.success {
  color: var(--success-color);
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid var(--success-color);
}

.error {
  color: var(--error-color);
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid var(--error-color);
}

.info {
  color: var(--info-color);
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid var(--info-color);
}

.confirm-box {
  background: rgba(51, 65, 85, 0.5);
  border: 2px solid var(--warning-color);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  margin-top: 10px;
}

th, td {
  border: 1px solid var(--border-color);
  padding: 10px;
  text-align: center;
}

th {
  background: var(--border-color);
  font-weight: 600;
  color: white;
  font-size: 13px;
}

tr:hover {
  background: rgba(51, 65, 85, 0.3);
}

.loading {
  text-align: center;
  padding: 30px;
  color: #94a3b8;
  font-size: 14px;
}

.chart-container {
  position: relative;
  height: 250px;
  width: 100%;
}

.lang-switcher {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 15px;
  gap: 10px;
}

.lang-btn {
  background: var(--bg-primary);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.3s;
}

.lang-btn:hover {
  background: var(--border-color);
}

.lang-btn.active {
  background: var(--success-color);
  border-color: var(--success-color);
  color: white;
}

.debug-box {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid var(--error-color);
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
  font-size: 12px;
  display: none;
}

@media (max-width: 768px) {
  body {
    padding: 10px;
  }
  
  .card {
    padding: 15px;
  }
  
  table {
    font-size: 11px;
  }
  
  th, td {
    padding: 8px;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  h1 {
    font-size: 20px;
  }
  
  h2 {
    font-size: 18px;
  }
}
</style>
</head>
<body>
<div class="container">

  <!-- Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© -->
  <div class="lang-switcher">
    <button class="lang-btn" onclick="switchLanguage('ar')" id="arBtn">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    <button class="lang-btn" onclick="switchLanguage('en')" id="enBtn">English</button>
  </div>

  <h1 id="pageTitle">ğŸ“ˆ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</h1>

  <!-- Ø´Ø±Ø­ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± -->
  <div class="card">
    <div class="info-box" id="investmentInfo">
      Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
    </div>
  </div>

  <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
  <div class="card">
    <div id="loadingUser" class="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    
    <div id="userData" style="display: none;">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label" id="userIdLabel">ğŸ‘¤ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
          <div class="stat-value" id="userIdValue">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label" id="priceLabel">ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù…</div>
          <div class="stat-value" id="priceValue">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label" id="balanceLabel">ğŸ’µ Ø§Ù„Ø±ØµÙŠØ¯</div>
          <div class="stat-value" id="balanceValue">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label" id="stocksLabel">ğŸ“¦ Ø§Ù„Ø£Ø³Ù‡Ù…</div>
          <div class="stat-value" id="stocksValue">--</div>
        </div>
      </div>

      <div class="info-box" id="feeInfo">
        ğŸ§¾ <span id="feeLabel">Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>: <span id="feeValue">0.05$ + 2%</span>
      </div>

      <input id="amount" type="number" min="1" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…" oninput="validateInput()">

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
        <button class="buy-btn" onclick="prepareAction('buy')" id="buyBtn">ğŸ›’ Ø´Ø±Ø§Ø¡</button>
        <button class="sell-btn" onclick="prepareAction('sell')" id="sellBtn">ğŸ’¸ Ø¨ÙŠØ¹</button>
      </div>

      <div id="msg" class="message-box" style="display: none;"></div>
      
      <div id="debugBox" class="debug-box"></div>
    </div>
  </div>

  <!-- ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© -->
  <div class="card" id="confirmBox" style="display: none;">
    <h3 id="confirmTitle">âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
    <div id="confirmText" style="margin: 15px 0; padding: 15px; background: rgba(30, 41, 59, 0.5); border-radius: 8px; line-height: 1.8;"></div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
      <button class="buy-btn" onclick="confirmAction()" id="confirmBtn">âœ… ØªØ£ÙƒÙŠØ¯</button>
      <button class="cancel-btn" onclick="cancelAction()" id="cancelBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>

  <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
  <div class="card">
    <h2 id="chartTitle">ğŸ“Š Ù…Ø®Ø·Ø· Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù…</h2>
    <div id="chartLoading" class="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·...</div>
    <div class="chart-container" id="chartContainer" style="display: none;">
      <canvas id="priceChart"></canvas>
    </div>
  </div>

  <!-- Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª -->
  <div class="card">
    <h2 id="transactionsTitle">ğŸ“‘ Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª</h2>
    <div id="transactionsLoading" class="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø§Øª...</div>
    <div id="transactionsContent" style="display: none;">
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th id="typeCol">Ø§Ù„Ù†ÙˆØ¹</th>
              <th id="qtyCol">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th id="priceCol">Ø§Ù„Ø³Ø¹Ø±</th>
              <th id="totalCol">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th id="dateCol">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            </tr>
          </thead>
          <tbody id="txTable"></tbody>
        </table>
      </div>
      <div id="noTransactions" style="text-align: center; padding: 20px; color: #94a3b8; display: none;">
        ğŸ“­ <span id="noTxText">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</span>
      </div>
    </div>
  </div>

</div>

<script>
/* ===================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===================== */
const params = new URLSearchParams(location.search);
const telegram_id = params.get('telegram_id') || '123456';
const defaultLang = params.get('lang') || 'ar';

let lang = defaultLang;
let stockPrice = 0;
let currentAction = null;
let adminFeeFixed = 0.05;
let adminFeePercent = 2;
let chartInstance = null;
let lastPriceCheck = null;

/* ===================== Ø§Ù„Ù†ØµÙˆØµ ===================== */
const texts = {
  ar: {
    pageTitle: "ğŸ“ˆ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±",
    info: `ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§ØŒ Ø­ÙŠØ« ÙŠØ±ØªÙØ¹ ÙˆÙŠÙ†Ø®ÙØ¶ Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù… Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆÙ‚.<br>
    Ù†Ø­Ù† Ù†Ø¹Ù…Ù„ ÙÙŠ Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¨ÙŠØ¹ Ø£Ø³Ù‡Ù…Ùƒ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.<br>
    Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ¹ ÙŠØªÙ… Ø®ØµÙ… Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.`,
    userIdLabel: "ğŸ‘¤ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
    priceLabel: "ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù…",
    balanceLabel: "ğŸ’µ Ø§Ù„Ø±ØµÙŠØ¯",
    stocksLabel: "ğŸ“¦ Ø§Ù„Ø£Ø³Ù‡Ù…",
    feeLabel: "ğŸ§¾ Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
    buyBtn: "ğŸ›’ Ø´Ø±Ø§Ø¡",
    sellBtn: "ğŸ’¸ Ø¨ÙŠØ¹",
    amountPlaceholder: "Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…",
    confirmTitle: "âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©",
    confirmBtn: "âœ… ØªØ£ÙƒÙŠØ¯",
    cancelBtn: "âŒ Ø¥Ù„ØºØ§Ø¡",
    chartTitle: "ğŸ“Š Ù…Ø®Ø·Ø· Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù…",
    transactionsTitle: "ğŸ“‘ Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª",
    typeCol: "Ø§Ù„Ù†ÙˆØ¹",
    qtyCol: "Ø§Ù„ÙƒÙ…ÙŠØ©",
    priceCol: "Ø§Ù„Ø³Ø¹Ø±",
    totalCol: "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
    dateCol: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
    noTxText: "Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ø³Ø§Ø¨Ù‚Ø©",
    buy: "Ø´Ø±Ø§Ø¡",
    sell: "Ø¨ÙŠØ¹",
    invalidQuantity: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©",
    insufficientBalance: "Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ",
    insufficientStocks: "Ø£Ø³Ù‡Ù… ØºÙŠØ± ÙƒØ§ÙÙŠØ©",
    operationSuccess: "âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­",
    operationFailed: "âŒ ÙØ´Ù„ ÙÙŠ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©",
    serverError: "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…",
    loadingData: "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
    noTransactions: "ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ø³Ø§Ø¨Ù‚Ø©",
    arBtn: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
    enBtn: "English"
  },
  en: {
    pageTitle: "ğŸ“ˆ Investment System",
    info: `You can buy stocks and hold them while prices rise and fall based on the market.<br>
    We operate long-term investment strategies, and you can sell your stocks at any time.<br>
    An administration fee applies on every buy or sell operation.`,
    userIdLabel: "ğŸ‘¤ User ID",
    priceLabel: "ğŸ’° Price",
    balanceLabel: "ğŸ’µ Balance",
    stocksLabel: "ğŸ“¦ Stocks",
    feeLabel: "ğŸ§¾ Admin Fee",
    buyBtn: "ğŸ›’ Buy",
    sellBtn: "ğŸ’¸ Sell",
    amountPlaceholder: "Enter quantity",
    confirmTitle: "âš ï¸ Confirm Action",
    confirmBtn: "âœ… Confirm",
    cancelBtn: "âŒ Cancel",
    chartTitle: "ğŸ“Š Stock Price Chart",
    transactionsTitle: "ğŸ“‘ Transactions",
    typeCol: "Type",
    qtyCol: "Qty",
    priceCol: "Price",
    totalCol: "Total",
    dateCol: "Date",
    noTxText: "No previous transactions",
    buy: "Buy",
    sell: "Sell",
    invalidQuantity: "Please enter a valid quantity",
    insufficientBalance: "Insufficient balance",
    insufficientStocks: "Insufficient stocks",
    operationSuccess: "âœ… Operation completed successfully",
    operationFailed: "âŒ Operation failed",
    serverError: "âŒ Server error",
    loadingData: "â³ Loading...",
    noTransactions: "ğŸ“­ No previous transactions",
    arBtn: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
    enBtn: "English"
  }
};

/* ===================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ===================== */
function initLanguage() {
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  document.getElementById('arBtn').textContent = texts[lang].arBtn;
  document.getElementById('enBtn').textContent = texts[lang].enBtn;
  
  if (lang === 'ar') {
    document.getElementById('arBtn').classList.add('active');
    document.getElementById('enBtn').classList.remove('active');
  } else {
    document.getElementById('enBtn').classList.add('active');
    document.getElementById('arBtn').classList.remove('active');
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
  document.getElementById("pageTitle").textContent = texts[lang].pageTitle;
  document.getElementById("investmentInfo").innerHTML = texts[lang].info;
  document.getElementById("userIdLabel").textContent = texts[lang].userIdLabel;
  document.getElementById("priceLabel").textContent = texts[lang].priceLabel;
  document.getElementById("balanceLabel").textContent = texts[lang].balanceLabel;
  document.getElementById("stocksLabel").textContent = texts[lang].stocksLabel;
  document.getElementById("feeLabel").textContent = texts[lang].feeLabel;
  document.getElementById("buyBtn").textContent = texts[lang].buyBtn;
  document.getElementById("sellBtn").textContent = texts[lang].sellBtn;
  document.getElementById("amount").placeholder = texts[lang].amountPlaceholder;
  document.getElementById("confirmTitle").textContent = texts[lang].confirmTitle;
  document.getElementById("confirmBtn").textContent = texts[lang].confirmBtn;
  document.getElementById("cancelBtn").textContent = texts[lang].cancelBtn;
  document.getElementById("chartTitle").textContent = texts[lang].chartTitle;
  document.getElementById("transactionsTitle").textContent = texts[lang].transactionsTitle;
  document.getElementById("typeCol").textContent = texts[lang].typeCol;
  document.getElementById("qtyCol").textContent = texts[lang].qtyCol;
  document.getElementById("priceCol").textContent = texts[lang].priceCol;
  document.getElementById("totalCol").textContent = texts[lang].totalCol;
  document.getElementById("dateCol").textContent = texts[lang].dateCol;
  document.getElementById("noTxText").textContent = texts[lang].noTxText;
  
  // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
  document.title = texts[lang].pageTitle;
}

/* ===================== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© ===================== */
function switchLanguage(newLang) {
  lang = newLang;
  initLanguage();
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  loadInvestment();
  loadTransactions();
  loadChart();
}

/* ===================== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===================== */
function showMsg(text, type = 'success') {
  const m = document.getElementById("msg");
  m.textContent = text;
  m.className = "message-box " + type;
  m.style.display = "block";
  
  setTimeout(() => {
    m.style.display = "none";
    m.textContent = "";
    m.className = "message-box";
  }, 5000);
}

function showDebug(msg) {
  const debug = document.getElementById("debugBox");
  debug.style.display = "block";
  debug.innerHTML = `<strong>ğŸ Debug:</strong> ${msg}`;
  console.log("ğŸ Debug:", msg);
}

function validateInput() {
  const input = document.getElementById("amount");
  if (input.value && input.value <= 0) {
    input.value = 1;
  }
}

/* ===================== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===================== */
async function loadInvestment() {
  try {
    showDebug(`Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${telegram_id}`);
    
    document.getElementById("loadingUser").style.display = "block";
    document.getElementById("userData").style.display = "none";

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£ÙˆÙ„Ø§Ù‹
    const pingResponse = await fetch('/api/investment-data?user_id=test', { method: 'HEAD' });
    if (!pingResponse.ok) {
      throw new Error('Ø§Ù„Ø³ÙŠØ±ÙØ± ØºÙŠØ± Ù…ØªØ§Ø­');
    }
    
    showDebug('Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ù†Ø§Ø¬Ø­');

    const response = await fetch(`/api/investment-data?user_id=${telegram_id}`);
    
    showDebug(`Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±: ${response.status} ${response.statusText}`);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
    }

    const data = await response.json();
    
    showDebug(`Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©: ${JSON.stringify(data)}`);
    
    if (data.status !== "success") {
      showMsg(data.message || texts[lang].serverError, 'error');
      showDebug(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${data.message}`);
      return;
    }

    stockPrice = Number(data.data.price);
    adminFeeFixed = Number(data.data.admin_fee_fixed);
    adminFeePercent = Number(data.data.admin_fee_percent);

    document.getElementById("userIdValue").textContent = telegram_id;
    document.getElementById("priceValue").textContent = `${stockPrice.toFixed(6)}$`;
    document.getElementById("balanceValue").textContent = `${Number(data.data.balance).toFixed(6)}$`;
    document.getElementById("stocksValue").textContent = data.data.stocks;
    document.getElementById("feeValue").textContent = `${adminFeeFixed}$ + ${adminFeePercent}%`;

    document.getElementById("loadingUser").style.display = "none";
    document.getElementById("userData").style.display = "block";
    
    showDebug('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±:", err);
    showDebug(`Ø®Ø·Ø£: ${err.message}`);
    showMsg(`${texts[lang].serverError}<br><small>${err.message}</small>`, 'error');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…Ø¤Ù‚Øª Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.getElementById("loadingUser").style.display = "none";
    document.getElementById("userData").style.display = "block";
  }
}

/* ===================== ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ===================== */
function prepareAction(type) {
  const qty = Number(document.getElementById("amount").value);
  
  if (!qty || qty <= 0) {
    showMsg(texts[lang].invalidQuantity, 'error');
    return;
  }

  const subtotal = qty * stockPrice;
  const fee = adminFeeFixed + (subtotal * adminFeePercent / 100);
  const total = type === "buy" ? subtotal + fee : subtotal - fee;

  currentAction = type;
  document.getElementById("confirmBox").style.display = "block";
  
  document.getElementById("confirmText").innerHTML = `
    <strong>${type === "buy" ? texts[lang].buy : texts[lang].sell} ${qty} ${lang === 'ar' ? 'Ø³Ù‡Ù…' : 'stocks'}</strong><br><br>
    ${lang === 'ar' ? 'Ø§Ù„Ø³Ø¹Ø±' : 'Price'}: ${stockPrice.toFixed(6)}$<br>
    ${lang === 'ar' ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ' : 'Subtotal'}: ${subtotal.toFixed(6)}$<br>
    ${lang === 'ar' ? 'Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' : 'Admin Fee'}: ${fee.toFixed(6)}$<br>
    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 10px 0;">
    <strong style="color: ${type === 'buy' ? '#22c55e' : '#ef4444'};">
      ${lang === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total'}: ${total.toFixed(6)}$
    </strong>
  `;
}

function cancelAction() {
  document.getElementById("confirmBox").style.display = "none";
  currentAction = null;
  document.getElementById("amount").value = "";
}

/* ===================== ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ===================== */
async function confirmAction() {
  const qty = Number(document.getElementById("amount").value);
  
  if (!currentAction || !qty || qty <= 0) {
    showMsg(texts[lang].invalidQuantity, 'error');
    return;
  }

  const url = currentAction === "buy" ? "/api/buy-stock" : "/api/sell-stock";
  
  showMsg(texts[lang].loadingData, 'info');

  try {
    const response = await fetch(url, {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: telegram_id, quantity: qty })
    });

    const data = await response.json();

    if (data.status === "success") {
      showMsg(texts[lang].operationSuccess, 'success');
      document.getElementById("amount").value = "";
      await loadInvestment();
      await loadTransactions();
    } else {
      showMsg(data.message || texts[lang].operationFailed, 'error');
    }

  } catch (err) {
    console.error("Error in transaction:", err);
    showMsg(texts[lang].serverError, 'error');
  }

  cancelAction();
}

/* ===================== Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª ===================== */
async function loadTransactions() {
  try {
    document.getElementById("transactionsLoading").style.display = "block";
    document.getElementById("transactionsContent").style.display = "none";

    const response = await fetch(`/api/transactions?user_id=${telegram_id}`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.status !== "success") {
      throw new Error(data.message || "Failed to load transactions");
    }

    const tableBody = document.getElementById("txTable");
    tableBody.innerHTML = "";

    if (data.data.length === 0) {
      document.getElementById("noTransactions").style.display = "block";
    } else {
      document.getElementById("noTransactions").style.display = "none";
      data.data.forEach(t => {
        const row = document.createElement("tr");
        const typeText = t.type === 'BUY' ? 
          (lang === 'ar' ? 'Ø´Ø±Ø§Ø¡' : 'Buy') : 
          (lang === 'ar' ? 'Ø¨ÙŠØ¹' : 'Sell');
        const typeColor = t.type === 'BUY' ? '#22c55e' : '#ef4444';
        
        row.innerHTML = `
          <td style="color: ${typeColor}; font-weight: 600;">${typeText}</td>
          <td>${t.quantity}</td>
          <td>${Number(t.price).toFixed(6)}$</td>
          <td style="color: ${typeColor};">${Number(t.total).toFixed(6)}$</td>
          <td>${new Date(t.date).toLocaleString(lang === 'ar' ? 'ar-SA' : 'en-US')}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    document.getElementById("transactionsLoading").style.display = "none";
    document.getElementById("transactionsContent").style.display = "block";
  } catch (err) {
    console.error("Error loading transactions:", err);
    document.getElementById("transactionsLoading").textContent = texts[lang].serverError;
    document.getElementById("transactionsLoading").style.display = "block";
  }
}

/* ===================== Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ===================== */
async function loadChart() {
  try {
    document.getElementById("chartLoading").style.display = "block";
    document.getElementById("chartContainer").style.display = "none";

    const response = await fetch('/api/stock-chart');
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.status !== "success" || !data.data || data.data.length === 0) {
      document.getElementById("chartLoading").textContent = lang === 'ar' ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø®Ø·Ø·" : "No chart data available";
      return;
    }

    // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (chartInstance) {
      chartInstance.destroy();
    }

    const ctx = document.getElementById("priceChart").getContext('2d');
    chartInstance = new Chart(ctx, {
      type: "line",
       {
        labels: data.data.map(x => {
          const date = new Date(x.date);
          return date.toLocaleTimeString(lang === 'ar' ? 'ar-SA' : 'en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        }),
        datasets: [{
          label: lang === 'ar' ? "Ø§Ù„Ø³Ø¹Ø±" : "Price",
           data.data.map(x => Number(x.price)),
          borderColor: "#22c55e",
          backgroundColor: "rgba(34, 197, 94, 0.1)",
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: "#22c55e",
          pointBorderColor: "#fff",
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: '#fff',
              font: {
                size: 14,
                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(30, 41, 59, 0.95)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#334155',
            borderWidth: 1,
            padding: 12,
            displayColors: true
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#94a3b8',
              maxRotation: 45,
              minRotation: 45,
              font: {
                size: 11
              }
            },
            grid: {
              color: 'rgba(51, 65, 85, 0.3)'
            }
          },
          y: {
            ticks: {
              color: '#94a3b8',
              callback: function(value) {
                return value.toFixed(6) + '$';
              },
              font: {
                size: 11
              }
            },
            grid: {
              color: 'rgba(51, 65, 85, 0.3)'
            }
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        },
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        }
      }
    });

    // ØªØ®Ø²ÙŠÙ† Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® ØªØ­Ø¯ÙŠØ«
    const latestEntry = data.data[data.data.length - 1];
    lastPriceCheck = latestEntry.date;

    document.getElementById("chartLoading").style.display = "none";
    document.getElementById("chartContainer").style.display = "block";
    console.log("ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø¨Ù†Ø¬Ø§Ø­");

  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ:", err);
    document.getElementById("chartLoading").textContent = texts[lang].serverError;
    document.getElementById("chartLoading").style.display = "block";
  }
}

/* ===================== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===================== */
async function checkForPriceUpdate() {
  try {
    const response = await fetch('/api/stock-chart');
    const data = await response.json();
    
    if (data.status !== "success" || !data.data || data.data.length === 0) {
      return;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
    const latestEntry = data.data[data.data.length - 1];
    const latestDate = latestEntry.date;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯
    if (!lastPriceCheck || latestDate > lastPriceCheck) {
      console.log("ğŸ“ˆ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø³Ø¹Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
      
      // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø´ÙŠØ¡
      await loadChart();      // Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
      await loadInvestment(); // Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø±ØµÙŠØ¯
      await loadTransactions(); // Ø§Ù„ØµÙÙ‚Ø§Øª
      
      lastPriceCheck = latestDate;
    }
  } catch (err) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø±:", err);
  }
}

/* ===================== ØªØ´ØºÙŠÙ„ ===================== */
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ØºØ©
initLanguage();

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ DOM Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
setTimeout(async () => {
  try {
    await loadInvestment();
    await loadTransactions();
    await loadChart();
  } catch (err) {
    console.error("Error initializing page:", err);
    showDebug(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ${err.message}`);
  }
}, 100);

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ø¯ÙŠØ«Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
setInterval(checkForPriceUpdate, 5000);
</script>

</body>
</html>
