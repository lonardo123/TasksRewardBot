<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Investment</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  background:#020617;
  color:#fff;
  font-family:Arial;
  padding:20px;
}
.card{
  background:#1e293b;
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;
}
.info{
  background:#020617;
  border:1px solid #334155;
  padding:12px;
  border-radius:10px;
  line-height:1.6;
  font-size:14px;
}
input,button{
  width:100%;
  padding:10px;
  margin-top:10px;
  border-radius:6px;
  border:none;
}
input{
  background:#020617;
  color:#fff;
  border:1px solid #334155;
}
button{
  font-size:16px;
  cursor:pointer;
}
.buy{ background:#22c55e; }
.sell{ background:#ef4444; }
.cancel{ background:#475569; }

.message{
  margin-top:10px;
  font-weight:bold;
}
.success{ color:#22c55e; }
.error{ color:#ef4444; }

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  border:1px solid #334155;
  padding:6px;
}
th{ background:#334155; }
</style>
</head>

<body>

<h2>ğŸ“ˆ Investment</h2>

<div class="info">
You can buy stocks and hold them while prices rise and fall.<br>
You can sell your stocks at any time.<br>
Admin fees apply on every transaction.
</div>
  
<!-- ğŸ”¹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© -->
<div class="card" id="totalStocksBox">
  <h3>ğŸ“Š Total Stocks Collected</h3>
  <div id="totalStocksValue" style="font-size:22px;margin-top:8px;">
    Loading...
  </div>
</div>
  
<div class="card">
  <p id="userId">ğŸ‘¤ User ID: --</p>
  <p id="price">ğŸ’° Price: --</p>
  <p id="balance">ğŸ’µ Balance: --</p>
  <p id="stocks">ğŸ“¦ My Stocks: --</p>
  <p id="fee">ğŸ§¾ Admin Fee: --</p>

  <input id="amount" type="number" min="1" placeholder="Enter stock quantity">

  <button class="buy" onclick="prepareAction('BUY')">ğŸ›’ Buy</button>
  <button class="sell" onclick="prepareAction('SELL')">ğŸ’¸ Sell</button>

  <div id="msg" class="message"></div>
</div>

<div class="card" id="confirmBox" style="display:none;">
  <div id="confirmText"></div>
  <button class="buy" onclick="confirmAction()">âœ… Confirm</button>
  <button class="cancel" onclick="cancelAction()">âŒ Cancel</button>
</div>

<div class="card">
  <h3>ğŸ“Š Stock Price Chart</h3>
  <canvas id="priceChart" height="120"></canvas>
</div>

<div class="card">
  <h3>ğŸ“‘ Transactions</h3>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Fee</th>
        <th>Total</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="txTable"></tbody>
  </table>
</div>

<script>
/* ================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ================== */
const params = new URLSearchParams(location.search);
const user_id = params.get('user_id');

if(!user_id){
  alert("User ID is missing");
  throw new Error("User ID missing");
}

let stockPrice = 0;
let feeFixed = 0;
let feePercent = 0;
let currentAction = null;

const priceEl   = document.getElementById("price");
const balanceEl = document.getElementById("balance");
const stocksEl  = document.getElementById("stocks");
const feeEl     = document.getElementById("fee");
const userIdEl  = document.getElementById("userId");
const msgEl     = document.getElementById("msg");

/* ================== Ø£Ø¯ÙˆØ§Øª ================== */
function showMsg(text, ok=true){
  msgEl.textContent = text;
  msgEl.className = "message " + (ok ? "success" : "error");
}

/* ================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ================== */
async function loadInvestment(){
  try{
    const r = await fetch(`/api/investment-data?user_id=${user_id}`);
    const j = await r.json();
    if(j.status !== "success") return showMsg(j.message,false);

    const d = j.data;

    stockPrice = Number(d.price);
    feeFixed   = Number(d.admin_fee_fixed);
    feePercent = Number(d.admin_fee_percent);

    userIdEl.textContent  = `ğŸ‘¤ User ID: ${user_id}`;
    priceEl.textContent   = `ğŸ’° Price: ${stockPrice.toFixed(6)}$`;
    balanceEl.textContent = `ğŸ’µ Balance: ${Number(d.balance).toFixed(6)}$`;
    stocksEl.textContent  = `ğŸ“¦ My Stocks: ${d.stocks}`;
    feeEl.textContent     = `ğŸ§¾ Admin Fee: ${feeFixed}$ + ${feePercent}%`;
  }catch{
    showMsg("Failed to load investment data",false);
  }
}

/* ================== ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ================== */
function prepareAction(type){
  const qty = Number(amount.value);
  if(!qty || qty <= 0) return showMsg("Invalid quantity", false);

  const subtotal = qty * stockPrice;
  const fee = feeFixed + (subtotal * feePercent / 100);
  const total = type === "BUY" ? subtotal + fee : subtotal - fee;

  currentAction = type;
  confirmBox.style.display = "block";
  confirmText.innerHTML = `
    <b>${type}</b> ${qty} stocks<br>
    Price: ${stockPrice.toFixed(6)}$<br>
    Subtotal: ${subtotal.toFixed(6)}$<br>
    Fee: ${fee.toFixed(6)}$<br>
    <b>Total: ${total.toFixed(6)}$</b>
  `;
}

function cancelAction(){
  confirmBox.style.display = "none";
  currentAction = null;
}

/* ================== ØªÙ†ÙÙŠØ° ================== */
async function confirmAction(){
  const qty = Number(amount.value);
  const endpoint = currentAction === "BUY" ? "/api/buy-stock" : "/api/sell-stock";

  const r = await fetch(endpoint,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ user_id, quantity: qty })
  });

  const j = await r.json();
  if(j.status === "success"){
    showMsg(j.message);
    loadInvestment();
    loadTransactions();
  }else{
    showMsg(j.message,false);
  }
  cancelAction();
}

/* ================== Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ================== */
async function loadTransactions(){
  const r = await fetch(`/api/transactions?user_id=${user_id}`);
  const j = await r.json();
  if(j.status !== "success") return;

  txTable.innerHTML = "";
  j.data.forEach(t=>{
    txTable.innerHTML += `
      <tr>
        <td>${t.type}</td>
        <td>${t.quantity}</td>
        <td>${Number(t.price).toFixed(6)}</td>
        <td>${Number(t.fee).toFixed(6)}</td>
        <td>${Number(t.total).toFixed(6)}</td>
        <td>${new Date(t.date).toLocaleString()}</td>
      </tr>
    `;
  });
}

/* ================== Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ================== */
async function loadChart(){
  const r = await fetch("/api/stock-chart");
  const j = await r.json();
  if(j.status !== "success") return;

  new Chart(document.getElementById("priceChart"),{
    type:"line",
    data:{
      labels:j.data.map(x=>new Date(x.date).toLocaleDateString()),
      datasets:[{
        data:j.data.map(x=>x.price),
        borderWidth:2,
        tension:0.4
      }]
    },
    options:{
      plugins:{ legend:{display:false} }
    }
  });
}
// =====================
// ØªØ­Ù…ÙŠÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ù‡Ù…
// =====================
async function loadTotalStocks() {
  try {
    const res = await fetch('/api/total-stocks');
    const data = await res.json();

    if (data.status === "success") {
      document.getElementById("totalStocksValue").textContent =
        data.total_stocks + " Stocks";
    } else {
      document.getElementById("totalStocksValue").textContent = "Error";
    }
  } catch (err) {
    document.getElementById("totalStocksValue").textContent = "Server Error";
  }
}


/* ================== ØªØ´ØºÙŠÙ„ ================== */
loadInvestment();
loadTransactions();
loadChart();
loadTotalStocks();  
</script>

</body>
</html>
