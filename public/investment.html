<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --bg-primary: #020617;
  --bg-secondary: #1e293b;
  --border-color: #334155;
  --text-color: #fff;
  --success-color: #22c55e;
  --error-color: #ef4444;
  --warning-color: #475569;
}

body {
  background: var(--bg-primary);
  color: var(--text-color);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  padding: 20px;
  margin: 0;
}

.card {
  background: var(--bg-secondary);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.info {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  padding: 15px;
  border-radius: 10px;
  line-height: 1.7;
  font-size: 15px;
  margin-bottom: 15px;
}

input, button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 8px;
  border: none;
  font-size: 15px;
  transition: all 0.3s ease;
}

input {
  background: var(--bg-primary);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  box-sizing: border-box;
}

input:focus {
  outline: 2px solid var(--success-color);
  border-color: var(--success-color);
}

button {
  cursor: pointer;
  font-weight: 600;
  letter-spacing: 0.5px;
}

button:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

.buy { 
  background: var(--success-color); 
  color: white;
}

.sell { 
  background: var(--error-color); 
  color: white;
}

.cancel { 
  background: var(--warning-color); 
  color: white;
}

.message {
  margin-top: 15px;
  padding: 10px;
  border-radius: 6px;
  font-weight: bold;
  text-align: center;
}

.success { 
  color: var(--success-color);
  background: rgba(34, 197, 94, 0.1);
}

.error { 
  color: var(--error-color);
  background: rgba(239, 68, 68, 0.1);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  margin-top: 10px;
}

th, td {
  border: 1px solid var(--border-color);
  padding: 10px;
  text-align: center;
}

th { 
  background: var(--border-color);
  font-weight: 600;
  color: white;
}

tr:hover {
  background: rgba(51, 65, 85, 0.3);
}

.loading {
  text-align: center;
  padding: 20px;
  color: #94a3b8;
}

/* Responsive Design */
@media (max-width: 768px) {
  body {
    padding: 10px;
  }
  
  .card {
    padding: 15px;
  }
  
  table {
    font-size: 12px;
  }
  
  th, td {
    padding: 8px;
  }
}
</style>
</head>

<body>

<h2 id="title">ğŸ“ˆ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</h2>

<!-- Ø´Ø±Ø­ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± -->
<div class="info" id="investmentInfo"></div>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
<div class="card">
  <div id="loadingUser" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
  <div id="userData" style="display: none;">
    <p id="userId">ğŸ‘¤ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: --</p>
    <p id="price">ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù…: --</p>
    <p id="balance">ğŸ’µ Ø§Ù„Ø±ØµÙŠØ¯: --</p>
    <p id="stocks">ğŸ“¦ Ø£Ø³Ù‡Ù…ÙŠ: --</p>
    <p id="fee">ğŸ§¾ Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: 0.05$ + 2%</p>

    <input id="amount" type="number" min="1" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…" oninput="validateInput()">

    <button class="buy" onclick="prepareAction('buy')">ğŸ›’ Ø´Ø±Ø§Ø¡</button>
    <button class="sell" onclick="prepareAction('sell')">ğŸ’¸ Ø¨ÙŠØ¹</button>

    <div id="msg" class="message"></div>
  </div>
</div>

<!-- ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© -->
<div class="card" id="confirmBox" style="display:none;">
  <div id="confirmText"></div>
  <button class="buy" onclick="confirmAction()">âœ… ØªØ£ÙƒÙŠØ¯</button>
  <button class="cancel" onclick="cancelAction()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
</div>

<!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
<div class="card">
  <h3>ğŸ“Š Ù…Ø®Ø·Ø· Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù…</h3>
  <div id="chartLoading" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·...</div>
  <canvas id="priceChart" height="200" style="display: none;"></canvas>
</div>

<!-- Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª -->
<div class="card">
  <h3>ğŸ“‘ Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª</h3>
  <div id="transactionsLoading" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø§Øª...</div>
  <div id="transactionsContent" style="display: none;">
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ù†ÙˆØ¹</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        </tr>
      </thead>
      <tbody id="txTable"></tbody>
    </table>
  </div>
</div>

<script>
/* ===================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===================== */
const params = new URLSearchParams(location.search);
const telegram_id = params.get('telegram_id') || '123456';
const lang = params.get('lang') || 'ar';

let stockPrice = 0;
let currentAction = null;
let adminFeeFixed = 0.05;
let adminFeePercent = 2;
let chartInstance = null;

/* ===================== Ø§Ù„Ù†ØµÙˆØµ ===================== */
const texts = {
  ar: {
    title: "ğŸ“ˆ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±",
    info: `ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§ØŒ Ø­ÙŠØ« ÙŠØ±ØªÙØ¹ ÙˆÙŠÙ†Ø®ÙØ¶ Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù… Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆÙ‚.<br>
    Ù†Ø­Ù† Ù†Ø¹Ù…Ù„ ÙÙŠ Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¨ÙŠØ¹ Ø£Ø³Ù‡Ù…Ùƒ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.<br>
    Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ¹ ÙŠØªÙ… Ø®ØµÙ… Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.`,
    buy: "Ø´Ø±Ø§Ø¡",
    sell: "Ø¨ÙŠØ¹",
    invalidQuantity: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©",
    insufficientBalance: "Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ",
    insufficientStocks: "Ø£Ø³Ù‡Ù… ØºÙŠØ± ÙƒØ§ÙÙŠØ©",
    operationSuccess: "ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­",
    operationFailed: "ÙØ´Ù„ ÙÙŠ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©",
    serverError: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…",
    loadingData: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
    noTransactions: "Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ø³Ø§Ø¨Ù‚Ø©"
  },
  en: {
    title: "ğŸ“ˆ Investment System",
    info: `You can buy stocks and hold them while prices rise and fall based on the market.<br>
    We operate long-term investment strategies, and you can sell your stocks at any time.<br>
    An administration fee applies on every buy or sell operation.`,
    buy: "Buy",
    sell: "Sell",
    invalidQuantity: "Please enter a valid quantity",
    insufficientBalance: "Insufficient balance",
    insufficientStocks: "Insufficient stocks",
    operationSuccess: "Operation completed successfully",
    operationFailed: "Operation failed",
    serverError: "Server error",
    loadingData: "Loading data...",
    noTransactions: "No previous transactions"
  }
};

/* ===================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ===================== */
document.getElementById("title").innerText = texts[lang].title;
document.getElementById("investmentInfo").innerHTML = texts[lang].info;
document.documentElement.lang = lang;
document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

/* ===================== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===================== */
function showMsg(text, ok = true) {
  const m = document.getElementById("msg");
  m.textContent = text;
  m.className = "message " + (ok ? "success" : "error");
  
  setTimeout(() => {
    if (m.textContent === text) {
      m.textContent = "";
      m.className = "message";
    }
  }, 5000);
}

function validateInput() {
  const input = document.getElementById("amount");
  if (input.value && input.value <= 0) {
    input.value = 1;
  }
}

/* ===================== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===================== */
async function loadInvestment() {
  try {
    const loading = document.getElementById("loadingUser");
    const userData = document.getElementById("userData");
    
    loading.style.display = "block";
    userData.style.display = "none";

     const res = await fetch(`/api/investment-data?user_id=${telegram_id}`);

    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.status !== "success") {
      showMsg(data.message || texts[lang].serverError, false);
      return;
    }

    stockPrice = Number(data.data.price);
    adminFeeFixed = Number(data.data.admin_fee_fixed);
    adminFeePercent = Number(data.data.admin_fee_percent);

    document.getElementById("userId").textContent = `ğŸ‘¤ ${lang === 'ar' ? 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' : 'User ID'}: ${telegram_id}`;
    document.getElementById("price").textContent = `ğŸ’° ${lang === 'ar' ? 'Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù…' : 'Price'}: ${stockPrice.toFixed(6)}$`;
    document.getElementById("balance").textContent = `ğŸ’µ ${lang === 'ar' ? 'Ø§Ù„Ø±ØµÙŠØ¯' : 'Balance'}: ${Number(data.data.balance).toFixed(6)}$`;
    document.getElementById("stocks").textContent = `ğŸ“¦ ${lang === 'ar' ? 'Ø£Ø³Ù‡Ù…ÙŠ' : 'My Stocks'}: ${data.data.stocks}`;
    document.getElementById("fee").textContent = `ğŸ§¾ ${lang === 'ar' ? 'Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' : 'Admin Fee'}: ${adminFeeFixed}$ + ${adminFeePercent}%`;

    loading.style.display = "none";
    userData.style.display = "block";
  } catch (err) {
    console.error("Error loading investment data:", err);
    showMsg(texts[lang].serverError, false);
    document.getElementById("loadingUser").style.display = "none";
    document.getElementById("userData").style.display = "block";
  }
}

/* ===================== ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ===================== */
function prepareAction(type) {
  const qty = Number(document.getElementById("amount").value);
  
  if (!qty || qty <= 0) {
    showMsg(texts[lang].invalidQuantity, false);
    return;
  }

  const subtotal = qty * stockPrice;
  const fee = adminFeeFixed + (subtotal * adminFeePercent / 100);
  const total = type === "buy" ? subtotal + fee : subtotal - fee;

  currentAction = type;
  document.getElementById("confirmBox").style.display = "block";
  
  document.getElementById("confirmText").innerHTML = `
    ${type === "buy" ? texts[lang].buy : texts[lang].sell} ${qty} ${lang === 'ar' ? 'Ø³Ù‡Ù…' : 'stocks'}<br>
    ${lang === 'ar' ? 'Ø§Ù„Ø³Ø¹Ø±' : 'Price'}: ${stockPrice.toFixed(6)}$<br>
    ${lang === 'ar' ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ' : 'Subtotal'}: ${subtotal.toFixed(6)}$<br>
    ${lang === 'ar' ? 'Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' : 'Admin Fee'}: ${fee.toFixed(6)}$<br>
    <b>${lang === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total'}: ${total.toFixed(6)}$</b>
  `;
}

function cancelAction() {
  document.getElementById("confirmBox").style.display = "none";
  currentAction = null;
  document.getElementById("amount").value = "";
}

/* ===================== ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ===================== */
async function confirmAction() {
  const qty = Number(document.getElementById("amount").value);
  
  if (!currentAction || !qty || qty <= 0) {
    showMsg(texts[lang].invalidQuantity, false);
    return;
  }

  const url = currentAction === "buy" ? "/api/buy-stock" : "/api/sell-stock";
  const loadingMsg = document.getElementById("msg");
  
  loadingMsg.textContent = texts[lang].loadingData;
  loadingMsg.className = "message";

  try {
    const response = await fetch(url, {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: telegram_id, quantity: qty })
    });

    const data = await response.json();

    if (data.status === "success") {
      showMsg(texts[lang].operationSuccess);
      document.getElementById("amount").value = "";
      await loadInvestment();
      await loadTransactions();
    } else {
      showMsg(data.message || texts[lang].operationFailed, false);
    }

  } catch (err) {
    console.error("Error in transaction:", err);
    showMsg(texts[lang].serverError, false);
  }

  cancelAction();
}

/* ===================== Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª ===================== */
async function loadTransactions() {
  try {
    document.getElementById("transactionsLoading").style.display = "block";
    document.getElementById("transactionsContent").style.display = "none";

    const response = await fetch(`/api/transactions?user_id=${telegram_id}`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.status !== "success") {
      throw new Error(data.message || "Failed to load transactions");
    }

    const tableBody = document.getElementById("txTable");
    tableBody.innerHTML = "";

    if (data.data.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#94a3b8;">${texts[lang].noTransactions}</td></tr>`;
    } else {
      data.data.forEach(t => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${t.type === 'BUY' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'}</td>
          <td>${t.quantity}</td>
          <td>${Number(t.price).toFixed(6)}$</td>
          <td>${Number(t.total).toFixed(6)}$</td>
          <td>${new Date(t.date).toLocaleString(lang === 'ar' ? 'ar-SA' : 'en-US')}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    document.getElementById("transactionsLoading").style.display = "none";
    document.getElementById("transactionsContent").style.display = "block";
  } catch (err) {
    console.error("Error loading transactions:", err);
    document.getElementById("transactionsLoading").textContent = texts[lang].serverError;
  }
}

// ====================== Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø­ÙŠ ======================
async function loadChart(){
  try{
    const res = await fetch('/api/stock-chart');
    const d = await res.json();
    if(d.status !== "success") throw new Error(d.message);

    new Chart(document.getElementById("priceChart"),{
      type:"line",
      data:{
        labels:d.data.map(x=>x.date),
        datasets:[{
          label:"Price",
          data:d.data.map(x=>x.price),
          borderColor:"#22c55e",
          backgroundColor:"rgba(34,197,94,0.2)",
          borderWidth:2,
          tension:0.4
        }]
      },
      options:{
        plugins:{legend:{display:false}},
        scales:{y:{ticks:{callback:v=>v.toFixed(6)}}}
      }
    });
  }catch(err){console.error(err);}
}
/* ===================== ØªØ´ØºÙŠÙ„ ===================== */
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ
Promise.all([
  loadInvestment(),
  loadTransactions(),
  loadChart()
]).catch(err => {
  console.error("Error initializing page:", err);
});

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
setInterval(() => {
  loadInvestment();
  loadTransactions();
}, 30000);
</script>

</body>
</html>
